import {EventEmitter}from'events';import Fo from'ajv';import zn from'zod-to-json-schema';import*as P from'fs';import {createWriteStream}from'fs';import*as Y from'path';import {join,dirname,isAbsolute,normalize,resolve,relative}from'path';import {mkdir,appendFile,rm,readFile,writeFile,unlink,copyFile}from'fs/promises';import {homedir,tmpdir}from'os';import {randomBytes,createHash}from'crypto';import {Composio,AuthScheme}from'@composio/core';import {exec,execFile}from'child_process';import {promisify}from'util';import {z as z$1}from'zod';export{E2BProvider,createE2BProvider}from'@evolvingmachines/e2b';export{DaytonaProvider,createDaytonaProvider}from'@evolvingmachines/daytona';export{ModalProvider,createModalProvider}from'@evolvingmachines/modal';var Cn={CLAUDE:"claude",CODEX:"codex",GEMINI:"gemini",QWEN:"qwen",KIMI:"kimi",OPENCODE:"opencode"},Te={strict:{coerceTypes:false,removeAdditional:false,useDefaults:false,allErrors:true},loose:{coerceTypes:"array",removeAdditional:false,useDefaults:true,allErrors:true}};var Ee={claude:{image:"evolve-all",apiKeyEnv:"ANTHROPIC_API_KEY",oauthEnv:"CLAUDE_CODE_OAUTH_TOKEN",baseUrlEnv:"ANTHROPIC_BASE_URL",defaultModel:"opus",models:[{alias:"opus",modelId:"claude-opus-4-6",description:"Complex reasoning, R&D, architecting"},{alias:"sonnet",modelId:"claude-sonnet-4-5-20250929",description:"Daily coding, features, tests"},{alias:"haiku",modelId:"claude-haiku-4-5-20251001",description:"Quick tasks, syntax correction"},{alias:"opus[1m]",modelId:"opus[1m]",description:"Complex reasoning with 1M context window"},{alias:"sonnet[1m]",modelId:"sonnet[1m]",description:"Daily coding with 1M context window"}],systemPromptFile:"CLAUDE.md",mcpConfig:{settingsDir:"~/.claude",filename:"settings.json",format:"json",projectConfig:true},skillsConfig:{sourceDir:"/home/user/.evolve/skills",targetDir:"/home/user/.claude/skills"},buildCommand:({prompt:t,model:e,isResume:n})=>`echo "${t}" | claude -p ${n?"--continue ":""}--model ${e} --output-format stream-json --verbose --dangerously-skip-permissions`},codex:{image:"evolve-all",apiKeyEnv:"OPENAI_API_KEY",oauthEnv:"CODEX_OAUTH_FILE_PATH",oauthFileName:"auth.json",baseUrlEnv:"OPENAI_BASE_URL",defaultModel:"gpt-5.2",models:[{alias:"gpt-5.2",modelId:"gpt-5.2",description:"Base model"},{alias:"gpt-5.2-codex",modelId:"gpt-5.2-codex",description:"Code-optimized"},{alias:"gpt-5.1-codex-max",modelId:"gpt-5.1-codex-max",description:"Best reasoning (xhigh effort)"},{alias:"gpt-5.1-mini",modelId:"gpt-5.1-mini",description:"Smaller/faster"}],systemPromptFile:"AGENTS.md",mcpConfig:{settingsDir:"~/.codex",filename:"config.toml",format:"toml"},skillsConfig:{sourceDir:"/home/user/.evolve/skills",targetDir:"/home/user/.codex/skills"},setupCommand:`printf '%s\\n' "$OPENAI_API_KEY" | codex login --with-api-key`,buildCommand:({prompt:t,model:e,isResume:n,reasoningEffort:i})=>{let c=i?` -c model_reasoning_effort="${i}"`:"";return `printf '%s' "${t}" | codex exec --model ${e}${c} --dangerously-bypass-approvals-and-sandbox --skip-git-repo-check --json${n?" resume --last":""}`}},gemini:{image:"evolve-all",apiKeyEnv:"GEMINI_API_KEY",oauthEnv:"GEMINI_OAUTH_FILE_PATH",oauthFileName:"oauth_creds.json",oauthActivationEnv:{key:"GOOGLE_GENAI_USE_GCA",value:"true"},baseUrlEnv:"GOOGLE_GEMINI_BASE_URL",defaultModel:"gemini-3-flash-preview",models:[{alias:"gemini-3.1-pro-preview",modelId:"gemini-3.1-pro-preview",description:"Latest pro preview"},{alias:"gemini-3-pro-preview",modelId:"gemini-3-pro-preview",description:"Pro preview"},{alias:"gemini-3-flash-preview",modelId:"gemini-3-flash-preview",description:"Latest flash preview"},{alias:"gemini-2.5-pro",modelId:"gemini-2.5-pro",description:"Complex tasks, deep reasoning"},{alias:"gemini-2.5-flash",modelId:"gemini-2.5-flash",description:"Balance speed/reasoning"},{alias:"gemini-2.5-flash-lite",modelId:"gemini-2.5-flash-lite",description:"Simple tasks, fastest"}],systemPromptFile:"GEMINI.md",mcpConfig:{settingsDir:"~/.gemini",filename:"settings.json",format:"json"},skillsConfig:{sourceDir:"/home/user/.evolve/skills",targetDir:"/home/user/.gemini/skills"},usePassthroughGateway:true,buildCommand:({prompt:t,model:e,isResume:n})=>`gemini "${t}" ${n?"--resume latest ":""}--model ${e} --yolo --output-format stream-json`},qwen:{image:"evolve-all",apiKeyEnv:"OPENAI_API_KEY",baseUrlEnv:"OPENAI_BASE_URL",defaultModel:"qwen3.5-plus",models:[{alias:"qwen3.5-plus",modelId:"qwen3.5-plus",description:"Latest flagship, code + reasoning"},{alias:"qwen3-coder-plus",modelId:"qwen3-coder-plus",description:"Code generation, debugging"},{alias:"qwen3-vl-plus",modelId:"qwen3-vl-plus",description:"Vision + language, multimodal"}],systemPromptFile:"QWEN.md",mcpConfig:{settingsDir:"~/.qwen",filename:"settings.json",format:"json"},skillsConfig:{sourceDir:"/home/user/.evolve/skills",targetDir:"/home/user/.qwen/skills",enableFlag:"--experimental-skills"},defaultBaseUrl:"https://dashscope-intl.aliyuncs.com/compatible-mode/v1",buildCommand:({prompt:t,model:e,isResume:n,isDirectMode:i,skills:c})=>{let s=n?"--continue ":"",a=c?.length?"--experimental-skills ":"",p=i||e.startsWith("dashscope/")?e:`dashscope/${e}`;return `qwen "${t}" ${s}${a}--auth-type openai --model ${p} --yolo --output-format stream-json`}},kimi:{image:"evolve-all",apiKeyEnv:"KIMI_API_KEY",baseUrlEnv:"KIMI_BASE_URL",defaultModel:"moonshot/kimi-k2.5",models:[{alias:"moonshot/kimi-k2.5",modelId:"moonshot/kimi-k2.5",description:"Latest multimodal, Agent Swarm capable"},{alias:"moonshot/kimi-k2-turbo-preview",modelId:"moonshot/kimi-k2-turbo-preview",description:"Fast turbo model"}],systemPromptFile:"AGENTS.md",mcpConfig:{settingsDir:"~/.kimi",filename:"mcp.json",format:"json"},skillsConfig:{sourceDir:"/home/user/.evolve/skills",targetDir:"/home/user/.kimi/skills"},defaultBaseUrl:"https://api.moonshot.ai/v1",buildCommand:({prompt:t,model:e,isResume:n})=>`printf '%s' "${t}" | KIMI_MODEL_NAME=${e} kimi --print --output-format stream-json --yolo ${n?"--continue ":""}`},opencode:{image:"evolve-all",apiKeyEnv:"OPENROUTER_API_KEY",baseUrlEnv:"OPENAI_BASE_URL",defaultModel:"openrouter/anthropic/claude-sonnet-4.6",providerEnvMap:{openrouter:{keyEnv:"OPENROUTER_API_KEY"}},gatewayConfigEnv:"OPENCODE_CONFIG_CONTENT",models:[{alias:"openrouter/anthropic/claude-sonnet-4.6",modelId:"openrouter/anthropic/claude-sonnet-4.6",description:"Anthropic Sonnet via OpenRouter"},{alias:"openrouter/anthropic/claude-opus-4.6",modelId:"openrouter/anthropic/claude-opus-4.6",description:"Anthropic Opus via OpenRouter"},{alias:"openrouter/anthropic/claude-haiku-4.5",modelId:"openrouter/anthropic/claude-haiku-4.5",description:"Anthropic Haiku via OpenRouter"},{alias:"openrouter/openai/gpt-5.2",modelId:"openrouter/openai/gpt-5.2",description:"OpenAI GPT-5.2 via OpenRouter"},{alias:"openrouter/openai/gpt-5.2-codex",modelId:"openrouter/openai/gpt-5.2-codex",description:"OpenAI Codex via OpenRouter"},{alias:"openrouter/openai/gpt-5.1-codex-max",modelId:"openrouter/openai/gpt-5.1-codex-max",description:"OpenAI Codex Max via OpenRouter"},{alias:"openrouter/google/gemini-3.1-pro-preview",modelId:"openrouter/google/gemini-3.1-pro-preview",description:"Gemini 3.1 Pro via OpenRouter"},{alias:"openrouter/google/gemini-3-pro-preview",modelId:"openrouter/google/gemini-3-pro-preview",description:"Gemini 3 Pro via OpenRouter"},{alias:"openrouter/google/gemini-3-flash-preview",modelId:"openrouter/google/gemini-3-flash-preview",description:"Gemini 3 Flash via OpenRouter"},{alias:"openrouter/qwen/qwen3-coder-plus",modelId:"openrouter/qwen/qwen3-coder-plus",description:"Qwen Coder via OpenRouter"},{alias:"openrouter/moonshotai/kimi-k2.5",modelId:"openrouter/moonshotai/kimi-k2.5",description:"Kimi K2.5 via OpenRouter"},{alias:"openrouter/z-ai/glm-5",modelId:"openrouter/z-ai/glm-5",description:"Zhipu GLM-5 via OpenRouter"}],systemPromptFile:"AGENTS.md",mcpConfig:{settingsDir:".",filename:"opencode.json",format:"json"},skillsConfig:{sourceDir:"/home/user/.evolve/skills",targetDir:"/home/user/.agents/skills"},checkpointDirs:["~/.local/share/opencode","~/.config/opencode","~/.local/state/opencode"],buildCommand:({prompt:t,model:e,isResume:n,isDirectMode:i})=>{let c=n?"--continue ":"",s=e.startsWith("openrouter/")?e:`openrouter/${e}`;return i?`OPENCODE_PERMISSION='{"*":"allow"}' opencode run ${c}--model ${s} --format json "${t}" < /dev/null`:`OPENCODE_PERMISSION='{"*":"allow"}' opencode run ${c}--model litellm/${s} --format json "${t}" < /dev/null`}}};function O(t){let e=Ee[t];if(!e)throw new Error(`Unknown agent type: ${t}`);return e}function Sn(t){return t in Ee}function Re(t){return t.replace(/^~/,"/home/user")}function F(t){let e=O(t);return `${Re(e.mcpConfig.settingsDir)}/${e.mcpConfig.filename}`}function L(t){let e=O(t);return Re(e.mcpConfig.settingsDir)}function N(t){if(t instanceof Error){let e=t.message.toLowerCase();return e.includes("not found")||e.includes("enoent")||e.includes("no such file")||e.includes("does not exist")}return  false}function Pe(t,e){let n=[e.command,e.url].filter(Boolean);if(n.length===0)throw new Error(`MCP server "${t}" must specify command or url`);if(n.length>1)throw new Error(`MCP server "${t}" cannot specify both command and url`)}function ne(t){for(let[e,n]of Object.entries(t))Pe(e,n);}function oe(t){return t.type?t.type:t.command?"stdio":"sse"}function _n(t){let e=oe(t);return {...t,type:e}}function Tn(t){let{type:e,url:n,...i}=t;return oe(t)==="http"&&n?{httpUrl:n,...i}:n?{url:n,...i}:i}function En(t){return {type:oe(t),...t}}function Rn(t){let{type:e,...n}=t;return n.command?{...n,transport:"stdio"}:n.url&&(e==="http"||e==="sse")?{...n,transport:e}:n}async function Oe(t,e,n,i){ne(n);let c=L(e),s=F(e);await t.files.makeDir(c);let a={};try{let r=await t.files.read(s);typeof r=="string"&&(a=JSON.parse(r));}catch(r){if(!N(r))throw r}let p=Object.fromEntries(Object.entries(n).map(([r,l])=>[r,i(l)]));await t.files.write(s,JSON.stringify({...a,mcpServers:p},null,2));}async function ie(t,e,n){ne(n);let i=L("claude"),c=F("claude"),s=Object.fromEntries(Object.entries(n).map(([p,r])=>[p,En(r)]));await t.files.write(`${e}/.mcp.json`,JSON.stringify({mcpServers:s},null,2)),await t.files.makeDir(i);let a={};try{let p=await t.files.read(c);typeof p=="string"&&(a=JSON.parse(p));}catch(p){if(!N(p))throw p}a.enableAllProjectMcpServers=true,await t.files.write(c,JSON.stringify(a,null,2));}async function se(t,e){await Oe(t,"gemini",e,_n);}async function re(t,e){await Oe(t,"qwen",e,Tn);}async function Ie(t,e){await Oe(t,"kimi",e,Rn);}async function Me(t,e,n){ne(n);let i=`${e}/opencode.json`,c={};try{let a=await t.files.read(i);typeof a=="string"&&(c=JSON.parse(a));}catch(a){if(!N(a))throw a}let s=Object.fromEntries(Object.entries(n).map(([a,p])=>[a,Pn(p)]));await t.files.write(i,JSON.stringify({...c,mcp:s},null,2));}function Pn(t){let e=oe(t);if(e==="stdio"&&t.command){let i={type:"local",command:t.args?[t.command,...t.args]:[t.command]};return t.env&&Object.keys(t.env).length>0&&(i.environment=t.env),i}if(t.url){let n={type:"remote",url:t.url};return t.headers&&Object.keys(t.headers).length>0&&(n.headers=t.headers),n}return {type:e==="stdio"?"local":"remote",...t}}function T(t){return typeof t=="string"?`"${t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`:Array.isArray(t)?`[${t.map(e=>T(e)).join(", ")}]`:typeof t=="object"&&t!==null?`{ ${Object.entries(t).map(([n,i])=>`${n} = ${T(i)}`).join(", ")} }`:typeof t=="boolean"?t?"true":"false":String(t)}async function ae(t,e){for(let[r,l]of Object.entries(e))Pe(r,l);let n=L("codex"),i=F("codex");await t.files.makeDir(n);let c="";try{let r=await t.files.read(i);typeof r=="string"&&(c=r);}catch(r){if(!N(r))throw r}let s=[],a=[];c.includes("experimental_use_rmcp_client")||(s.push("# Enable improved RMCP client (recommended)"),s.push("experimental_use_rmcp_client = true")),c.includes("[mcp_servers]")||a.push("[mcp_servers]","");for(let[r,l]of Object.entries(e)){if(c.includes(`[mcp_servers.${r}]`))continue;a.push(`[mcp_servers.${r}]`);let o=l.type??(l.command?"stdio":"http");if(o==="http"||o==="sse"||!!l.url){if(!l.url)throw new Error(`MCP server "${r}" is missing url for ${o} transport`);a.push(`url = ${T(l.url)}`),l.bearerTokenEnvVar&&a.push(`bearer_token_env_var = ${T(l.bearerTokenEnvVar)}`);let d=l.httpHeaders??l.headers;d&&Object.keys(d).length>0&&a.push(`http_headers = ${T(d)}`),l.envHttpHeaders&&Object.keys(l.envHttpHeaders).length>0&&a.push(`env_http_headers = ${T(l.envHttpHeaders)}`);}else a.push(`command = ${T(l.command)}`),l.args&&l.args.length>0&&a.push(`args = ${T(l.args)}`),l.cwd&&a.push(`cwd = ${T(l.cwd)}`);l.env&&Object.keys(l.env).length>0&&a.push(`env = ${T(l.env)}`),l.envVars&&l.envVars.length>0&&a.push(`env_vars = ${T(l.envVars)}`),a.push("");}let p=[c.trim(),s.join(`
`),a.join(`
`)].filter(r=>r.length>0);await t.files.write(i,p.join(`

`)+`
`);}async function Ae(t,e,n,i){if(!(!i||Object.keys(i).length===0))switch(t){case "claude":await ie(e,n,i);break;case "codex":await ae(e,i);break;case "gemini":await se(e,i);break;case "qwen":await re(e,i);break;case "kimi":await Ie(e,i);break;case "opencode":await Me(e,n,i);break;default:throw new Error(`Unknown agent type for MCP config: ${t}`)}}function ce(){let t={};return function(l){let o;try{o=JSON.parse(l);}catch{return null}if(o._meta||o._prompt)return null;let u=o.session_id;switch(o.type){case "system":return null;case "assistant":return e(o.message?.content,"assistant",u);case "user":{let d=o.message?.content;return typeof d=="string"||Array.isArray(d)&&d.length===1&&d[0].type==="text"?null:e(d,"user",u)}case "result":return null;default:return null}};function e(r,l,o){if(typeof r=="string")return l==="user"?null:[{sessionId:o,update:{sessionUpdate:"agent_message_chunk",content:{type:"text",text:r}}}];if(!r||!Array.isArray(r))return null;let u=[];for(let d of r){let m=null;switch(d.type){case "text":case "text_delta":if(l==="user")break;m={sessionUpdate:"agent_message_chunk",content:{type:"text",text:d.text}};break;case "image":if(l==="user")break;m={sessionUpdate:"agent_message_chunk",content:{type:"image",data:d.source?.type==="base64"?d.source.data:"",mimeType:d.source?.type==="base64"?d.source.media_type:"",uri:d.source?.type==="url"?d.source.url:void 0}};break;case "thinking":case "thinking_delta":m={sessionUpdate:"agent_thought_chunk",content:{type:"text",text:d.thinking}};break;case "tool_use":case "server_tool_use":case "mcp_tool_use":{if(t[d.id]=d,d.name==="TodoWrite")Array.isArray(d.input?.todos)&&(m={sessionUpdate:"plan",entries:a(d.input)});else {let f=n(d);m={sessionUpdate:"tool_call",toolCallId:d.id,status:"pending",...f};}break}case "tool_result":case "tool_search_tool_result":case "web_fetch_tool_result":case "web_search_tool_result":case "code_execution_tool_result":case "bash_code_execution_tool_result":case "text_editor_code_execution_tool_result":case "mcp_tool_result":{let f=t[d.tool_use_id];if(!f||(delete t[d.tool_use_id],f.name==="TodoWrite"))break;m={sessionUpdate:"tool_call_update",toolCallId:d.tool_use_id,status:"is_error"in d&&d.is_error?"failed":"completed",...i(d,f)};break}}m&&u.push({sessionId:o,update:m});}return u.length>0?u:null}function n(r){let l=r.name,o=r.input||{};switch(l){case "Task":return {title:o.description||"Task",kind:"think",content:o.prompt?[{type:"content",content:{type:"text",text:o.prompt}}]:[],rawInput:o};case "NotebookRead":return {title:o.notebook_path?`Read Notebook ${o.notebook_path}`:"Read Notebook",kind:"read",content:[],locations:o.notebook_path?[{path:o.notebook_path}]:[],rawInput:o};case "NotebookEdit":return {title:o.notebook_path?`Edit Notebook ${o.notebook_path}`:"Edit Notebook",kind:"edit",content:o.new_source?[{type:"content",content:{type:"text",text:o.new_source}}]:[],locations:o.notebook_path?[{path:o.notebook_path}]:[],rawInput:o};case "Bash":return {title:o.command?"`"+o.command.replaceAll("`","\\`")+"`":"Terminal",kind:"execute",content:o.description?[{type:"content",content:{type:"text",text:o.description}}]:[],rawInput:o};case "BashOutput":return {title:"Tail Logs",kind:"execute",content:[],rawInput:o};case "KillShell":return {title:"Kill Process",kind:"execute",content:[],rawInput:o};case "Read":{let u="";return o.limit?u=" ("+((o.offset??0)+1)+" - "+((o.offset??0)+o.limit)+")":o.offset&&(u=" (from line "+(o.offset+1)+")"),{title:"Read "+(o.file_path??"File")+u,kind:"read",content:[],locations:o.file_path?[{path:o.file_path,line:o.offset??0}]:[],rawInput:o}}case "LS":return {title:o.path?`List \`${o.path}\` directory`:"List current directory",kind:"search",content:[],locations:[],rawInput:o};case "Edit":{let u=o.file_path;return {title:u?`Edit \`${u}\``:"Edit",kind:"edit",content:u?[{type:"diff",path:u,oldText:o.old_string??null,newText:o.new_string??""}]:[],locations:u?[{path:u}]:[],rawInput:o}}case "Write":return {title:o.file_path?`Write ${o.file_path}`:"Write",kind:"edit",content:o.file_path?[{type:"diff",path:o.file_path,oldText:null,newText:o.content??""}]:[],locations:o.file_path?[{path:o.file_path}]:[],rawInput:o};case "Glob":{let u="Find";return o.path&&(u+=` \`${o.path}\``),o.pattern&&(u+=` \`${o.pattern}\``),{title:u,kind:"search",content:[],locations:o.path?[{path:o.path}]:[],rawInput:o}}case "Grep":{let u="grep";return o["-i"]&&(u+=" -i"),o["-n"]&&(u+=" -n"),o["-A"]!==void 0&&(u+=` -A ${o["-A"]}`),o["-B"]!==void 0&&(u+=` -B ${o["-B"]}`),o["-C"]!==void 0&&(u+=` -C ${o["-C"]}`),o.output_mode==="files_with_matches"?u+=" -l":o.output_mode==="count"&&(u+=" -c"),o.head_limit!==void 0&&(u+=` | head -${o.head_limit}`),o.glob&&(u+=` --include="${o.glob}"`),o.type&&(u+=` --type=${o.type}`),o.multiline&&(u+=" -P"),u+=` "${o.pattern??""}"`,o.path&&(u+=` ${o.path}`),{title:u,kind:"search",content:[],rawInput:o}}case "WebFetch":return {title:o.url?`Fetch ${o.url}`:"Fetch",kind:"fetch",content:o.prompt?[{type:"content",content:{type:"text",text:o.prompt}}]:[],rawInput:o};case "WebSearch":{let u=`"${o.query??""}"`;return o.allowed_domains?.length>0&&(u+=` (allowed: ${o.allowed_domains.join(", ")})`),o.blocked_domains?.length>0&&(u+=` (blocked: ${o.blocked_domains.join(", ")})`),{title:u,kind:"fetch",content:[],rawInput:o}}case "TodoWrite":return {title:Array.isArray(o.todos)?`Update TODOs: ${o.todos.map(u=>u.content).join(", ")}`:"Update TODOs",kind:"think",content:[],rawInput:o};case "ExitPlanMode":return {title:"Ready to code?",kind:"switch_mode",content:o.plan?[{type:"content",content:{type:"text",text:o.plan}}]:[],rawInput:o};default:if(l?.startsWith("mcp__")){let u=l.split("__"),d=u[1]||"mcp",m=u.slice(2).join("__")||l;return {title:`${d}: ${m}`,kind:"other",content:[],rawInput:o}}return {title:l||"Unknown Tool",kind:"other",content:[],rawInput:o}}}function i(r,l){let o=r.content;switch(l?.name){case "Read":return Array.isArray(o)&&o.length>0?{content:o.map(u=>({type:"content",content:u.type==="text"?{type:"text",text:p(u.text)}:s(u,false)}))}:typeof o=="string"&&o.length>0?{content:[{type:"content",content:{type:"text",text:p(o)}}]}:{};case "Edit":case "Write":case "Bash":return c(o,r.is_error||false);case "ExitPlanMode":return {title:"Exited Plan Mode"};default:return c(o,"is_error"in r?r.is_error:false)}}function c(r,l=false){return Array.isArray(r)&&r.length>0?{content:r.map(o=>({type:"content",content:s(o,l)}))}:typeof r=="string"&&r.length>0?{content:[{type:"content",content:{type:"text",text:l?"```\n"+r+"\n```":r}}]}:{}}function s(r,l){if(r.type==="text")return l?{type:"text",text:"```\n"+r.text+"\n```"}:{type:"text",text:r.text};if(r.type==="image"){if(r.data&&r.mimeType)return {type:"image",data:r.data,mimeType:r.mimeType};if(r.source?.type==="base64")return {type:"image",data:r.source.data||"",mimeType:r.source.media_type||""};if(r.source?.type==="url")return {type:"image",data:"",mimeType:"",uri:r.source.url}}return r}function a(r){return r.todos.map(l=>({content:l.content,status:l.status||"pending",priority:"medium"}))}function p(r){let l="```",o=Array.from(r.matchAll(/^```+/gm));for(let[u]of o)for(;u.length>=l.length;)l+="`";return l+`
`+r+(r.endsWith(`
`)?"":`
`)+l}}function le(){return function(r){let l;try{l=JSON.parse(r);}catch{return null}if(l._meta||l._prompt)return null;let o=[];switch(l.type){case "thread.started":case "turn.started":case "turn.completed":return null;case "item.started":{let u=l.item;if(!u)return null;let d=e(u);d&&o.push({update:d});break}case "item.updated":{let u=l.item;if(!u)return null;let d=n(u);d&&o.push({update:d});break}case "item.completed":{let u=l.item;if(!u)return null;let d=i(u);d&&o.push({update:d});break}default:return null}return o.length>0?o:null};function e(p){let r=p.id;switch(p.type){case "mcp_tool_call":return {type:"mcp_tool_call",name:`${p.server}:${p.tool}`},{sessionUpdate:"tool_call",toolCallId:r,title:`${p.server}: ${p.tool}`,kind:"other",status:"in_progress",rawInput:p.arguments,content:[]};case "command_execution":return {type:"command_execution",name:p.command},{sessionUpdate:"tool_call",toolCallId:r,title:p.command?`\`${p.command}\``:"Execute Command",kind:"execute",status:"in_progress",rawInput:{command:p.command},content:[]};case "web_search":return {type:"web_search",name:p.query},{sessionUpdate:"tool_call",toolCallId:r,title:`Search: ${p.query??""}`,kind:"fetch",status:"in_progress",content:[]};case "todo_list":return {sessionUpdate:"plan",entries:a(p.items)};default:return null}}function n(p){return p.type==="todo_list"?{sessionUpdate:"plan",entries:a(p.items)}:null}function i(p){let r=p.id;switch(p.type){case "reasoning":return {sessionUpdate:"agent_thought_chunk",content:{type:"text",text:p.text??p.summary?.join(`
`)??p.content?.join(`
`)??""}};case "agent_message":return {sessionUpdate:"agent_message_chunk",content:{type:"text",text:p.text??""}};case "mcp_tool_call":{let o=c(p.result),u=p.status==="failed"||p.error?"failed":"completed";return {sessionUpdate:"tool_call_update",toolCallId:r,status:u,content:o}}case "command_execution":{let o=p.aggregated_output?[{type:"content",content:{type:"text",text:p.aggregated_output}}]:[],u=p.status==="completed"||p.exit_code===0?"completed":"failed";return {sessionUpdate:"tool_call_update",toolCallId:r,status:u,content:o}}case "file_change":{let o=p.changes??[],u=o.map(m=>({path:m.path})),d=o.length===1?`${o[0].kind==="add"?"Create":"Edit"} ${o[0].path}`:`Edit ${o.length} files`;return {sessionUpdate:"tool_call",toolCallId:r,title:d,kind:"edit",status:p.status==="completed"?"completed":"failed",content:o.map(m=>({type:"diff",path:m.path,oldText:m.kind==="add"?null:"",newText:""})),locations:u}}case "web_search":return {sessionUpdate:"tool_call",toolCallId:r,title:`Search: ${p.query??""}`,kind:"fetch",status:"completed",content:[]};case "todo_list":return {sessionUpdate:"plan",entries:a(p.items)};default:return null}}function c(p){return p?.content?Array.isArray(p.content)?p.content.map(r=>({type:"content",content:s(r)})):typeof p.content=="string"?[{type:"content",content:{type:"text",text:p.content}}]:[]:[]}function s(p){return p.type==="text"?{type:"text",text:p.text??""}:p.type==="image"?{type:"image",data:p.data??"",mimeType:p.mime_type??p.mimeType??"",uri:p.uri}:p}function a(p){if(!Array.isArray(p))return [];let r=false;return p.map(l=>{let o;return l.completed?o="completed":r?o="pending":(o="in_progress",r=true),{content:l.text??"",status:o,priority:"medium"}})}}var On={read_file:"read",read_many_files:"read",write_file:"edit",replace:"edit",edit_file:"edit",run_shell_command:"execute",shell:"execute",glob:"search",grep:"search",search_file_content:"search",list_directory:"search",brave_web_search:"fetch",web_search:"fetch",google_web_search:"fetch",web_fetch:"fetch",delegate_to_agent:"think",write_todos:"other",save_memory:"other",activate_skill:"other"};function pe(){return function(a){let p;try{p=JSON.parse(a);}catch{return null}if(p._meta||p._prompt)return null;let r=p.session_id,l=[];switch(p.type){case "init":case "result":return null;case "message":{let o=t(p);o&&l.push({sessionId:r,update:o});break}case "tool_use":{let o=e(p);o&&l.push({sessionId:r,update:o});break}case "tool_result":{let o=n(p);o&&l.push({sessionId:r,update:o});break}case "error":{let o=i(p);o&&l.push({sessionId:r,update:o});break}default:return null}return l.length>0?l:null};function t(s){let a=s.role,p=s.content;return p?a==="assistant"?{sessionUpdate:"agent_message_chunk",content:{type:"text",text:p}}:a==="user"?{sessionUpdate:"user_message_chunk",content:{type:"text",text:p}}:null:null}function e(s){let a=s.tool_id,p=s.tool_name,r=s.parameters||{},{title:l,kind:o,content:u,locations:d}=c(p,r);return {sessionUpdate:"tool_call",toolCallId:a,title:l,kind:o,status:"pending",rawInput:r,content:u,locations:d}}function n(s){let a=s.tool_id,p=s.status,r=s.output,l=s.error,o=[];return r&&typeof r=="string"&&r.length>0&&o.push({type:"content",content:{type:"text",text:p==="error"?`\`\`\`
${r}
\`\`\``:r}}),l?.message&&!r&&o.push({type:"content",content:{type:"text",text:`\`\`\`
${l.message}
\`\`\``}}),{sessionUpdate:"tool_call_update",toolCallId:a,status:p==="success"?"completed":"failed",content:o}}function i(s){let a=s.severity,p=s.message;return p?{sessionUpdate:"agent_message_chunk",content:{type:"text",text:`${a==="warning"?"\u26A0\uFE0F Warning":"\u274C Error"}: ${p}`}}:null}function c(s,a){let p=On[s]||"other",r=[],l=[],o=s;switch(s){case "read_file":o=`Read ${a.absolute_path||a.file_path||"file"}`,(a.absolute_path||a.file_path)&&l.push({path:a.absolute_path||a.file_path});break;case "write_file":o=`Write ${a.file_path||"file"}`,a.file_path&&(l.push({path:a.file_path}),r.push({type:"diff",path:a.file_path,oldText:null,newText:a.content||""}));break;case "edit_file":o=`Edit ${a.file_path||"file"}`,a.file_path&&l.push({path:a.file_path});break;case "replace":o=`Edit ${a.file_path||"file"}`,a.file_path&&(l.push({path:a.file_path}),(a.old_string!==void 0||a.new_string!==void 0)&&r.push({type:"diff",path:a.file_path,oldText:a.old_string||"",newText:a.new_string||""}));break;case "run_shell_command":case "shell":o=a.command?`\`${a.command}\``:"Run command",a.description&&r.push({type:"content",content:{type:"text",text:a.description}});break;case "brave_web_search":case "web_search":case "google_web_search":o=a.query?`"${a.query}"`:"Web search";break;case "web_fetch":o=a.prompt?`Fetch: ${a.prompt.substring(0,50)}...`:"Web fetch";break;case "glob":o=`Find ${a.pattern||"files"}`,a.dir_path&&l.push({path:a.dir_path});break;case "grep":case "search_file_content":o=`grep "${a.pattern||a.query||""}"`;break;case "list_directory":o=`List ${a.dir_path||a.path||"directory"}`,(a.dir_path||a.path)&&l.push({path:a.dir_path||a.path});break;case "read_many_files":o=`Read ${a.include?.length||"multiple"} files`,Array.isArray(a.include)&&a.include.forEach(u=>l.push({path:u}));break;case "delegate_to_agent":o=a.agent_name?`Agent: ${a.agent_name}`:"Delegate to agent";break;case "write_todos":o="Update todos";break;case "save_memory":o=a.fact?`Remember: "${a.fact.substring(0,40)}..."`:"Save memory";break;case "activate_skill":o=a.name?`Activate skill: ${a.name}`:"Activate skill";break;default:o=s;}return {title:o,kind:p,content:r,locations:l}}}var In={ReadFile:"read",ReadMediaFile:"read",WriteFile:"edit",StrReplaceFile:"edit",Shell:"execute",Glob:"search",Grep:"search",SearchWeb:"fetch",FetchURL:"fetch",Task:"think",Think:"think",CreateSubagent:"think",SetTodoList:"other"};function De(t){return /<system>\s*ERROR:/i.test(t)||t.includes("<error>")||t.includes("ToolError")}function lt(t){let e=/^data:([^;,]+)((?:;[^,]*)*),(.+)$/i.exec(t);if(!e)return null;let n=e[1]||"",i=e[2]||"",c=e[3]||"";return /;base64/i.test(i)?{mimeType:n,data:c}:null}function Ue(t){if(!t||typeof t!="object")return null;if(t.type==="text"&&typeof t.text=="string"&&t.text.length>0)return {type:"content",content:{type:"text",text:t.text}};if(t.type==="image_url"&&typeof t.image_url?.url=="string"){let e=t.image_url.url,n=lt(e);return n?{type:"content",content:{type:"image",data:n.data,mimeType:n.mimeType}}:{type:"content",content:{type:"image",data:"",mimeType:"",uri:e}}}return t.type==="video_url"&&typeof t.video_url?.url=="string"?{type:"content",content:{type:"text",text:`[video] ${t.video_url.url}`}}:t.type==="audio_url"&&typeof t.audio_url?.url=="string"?{type:"content",content:{type:"text",text:`[audio] ${t.audio_url.url}`}}:null}function $e(t){let e=[];if(typeof t=="string")return t.length>0&&e.push({type:"content",content:{type:"text",text:t}}),e;if(Array.isArray(t)){for(let n of t){if(typeof n=="string"&&n.length>0){e.push({type:"content",content:{type:"text",text:n}});continue}let i=Ue(n);i&&e.push(i);}return e}if(t&&typeof t=="object"){let n=Ue(t);n&&e.push(n);}return e}function Mn(t){return t.some(e=>e.type==="content"&&e.content.type==="text"&&De(e.content.text))}function An(t){if(!t||typeof t!="object")return null;if(t.type==="think"&&typeof t.think=="string"&&t.think.length>0)return {update:{sessionUpdate:"agent_thought_chunk",content:{type:"text",text:t.think}}};if(t.type==="text"&&typeof t.text=="string"&&t.text.length>0)return {update:{sessionUpdate:"agent_message_chunk",content:{type:"text",text:t.text}}};if(t.type==="image_url"&&typeof t.image_url?.url=="string"){let e=t.image_url.url,n=lt(e);return n?{update:{sessionUpdate:"agent_message_chunk",content:{type:"image",data:n.data,mimeType:n.mimeType}}}:{update:{sessionUpdate:"agent_message_chunk",content:{type:"image",data:"",mimeType:"",uri:e}}}}return t.type==="video_url"&&typeof t.video_url?.url=="string"?{update:{sessionUpdate:"agent_message_chunk",content:{type:"text",text:`[video] ${t.video_url.url}`}}}:t.type==="audio_url"&&typeof t.audio_url?.url=="string"?{update:{sessionUpdate:"agent_message_chunk",content:{type:"text",text:`[audio] ${t.audio_url.url}`}}}:null}function $n(t){return t==="in_progress"?"in_progress":t==="done"||t==="completed"?"completed":"pending"}function ct(t){if(!t||typeof t!="object")return [];let e=t.todos;return Array.isArray(e)?e.map(n=>{if(!n||typeof n!="object")return null;let i=n.title;if(typeof i!="string"||i.length===0)return null;let c=n.status;return {content:i,status:$n(c),priority:"medium"}}).filter(n=>n!==null):[]}function Fe(){let t=new Set,e=0;function n(p,r){return typeof p=="string"&&p.length>0?p:(e+=1,`kimi_${r.replace(/[^a-zA-Z0-9_]/g,"_")||"tool"}_${e}`)}return function(r){let l;try{l=JSON.parse(r);}catch{return null}if(!l||typeof l!="object"||"_meta"in l||"_prompt"in l)return null;let o=l.role;return o==="assistant"?i(l):o==="tool"?c(l):typeof l.type=="string"&&"payload"in l?s(l):null};function i(p){let r=[],l=p.content,o=p.tool_calls;if(typeof l=="string"&&l.length>0)r.push({update:{sessionUpdate:"agent_message_chunk",content:{type:"text",text:l}}});else if(Array.isArray(l))for(let u of l){let d=An(u);d&&r.push(d);}if(Array.isArray(o))for(let u of o){if(!u||typeof u!="object")continue;let d=u.function;if(!d)continue;let m=d.name??"",f=n(u.id,m),g;try{g=d.arguments?JSON.parse(d.arguments):{};}catch{g=d.arguments;}if(m==="SetTodoList"){let w=ct(g);w.length>0&&r.push({update:{sessionUpdate:"plan",entries:w}}),t.add(f);continue}let{title:h,kind:v,toolContent:x,locations:y}=a(m,typeof g=="object"&&g!==null?g:{});r.push({update:{sessionUpdate:"tool_call",toolCallId:f,title:h,kind:v,status:"pending",rawInput:g,content:x,locations:y}});}return r.length>0?r:null}function c(p){let r=p.tool_call_id;if(typeof r!="string"||r.length===0)return null;if(t.has(r))return t.delete(r),null;let l=p.content,o=[],u=false;if(typeof l=="string")u=De(l),l.length>0&&o.push({type:"content",content:{type:"text",text:l}});else if(Array.isArray(l))for(let d of l){let m=Ue(d);m&&(m.type==="content"&&m.content.type==="text"&&De(m.content.text)&&(u=true),o.push(m));}return [{update:{sessionUpdate:"tool_call_update",toolCallId:r,status:u?"failed":"completed",content:o}}]}function s(p){let r=p.type,l=p.payload??{},o=[];switch(r){case "TextPart":{let u=l.text;typeof u=="string"&&u.length>0&&o.push({update:{sessionUpdate:"agent_message_chunk",content:{type:"text",text:u}}});break}case "ThinkPart":{let u=l.think;typeof u=="string"&&u.length>0&&o.push({update:{sessionUpdate:"agent_thought_chunk",content:{type:"text",text:u}}});break}case "ToolCall":{let u=l.function?.name??"",d=n(l.id,u),m=l.function;if(!m)break;let f;try{f=m.arguments?JSON.parse(m.arguments):{};}catch{f=m.arguments;}if(u==="SetTodoList"){let y=ct(f);y.length>0&&o.push({update:{sessionUpdate:"plan",entries:y}}),t.add(d);break}let{title:g,kind:h,toolContent:v,locations:x}=a(u,typeof f=="object"&&f!==null?f:{});o.push({update:{sessionUpdate:"tool_call",toolCallId:d,title:g,kind:h,status:"pending",rawInput:f,content:v,locations:x}});break}case "ToolResult":{let u=l.tool_call_id;if(typeof u!="string"||u.length===0)break;if(t.has(u)){t.delete(u);break}let d=l.return_value??l.content,m=[],f=l.is_error===true;if(d&&typeof d=="object"&&!Array.isArray(d)){let g=d;f=f||g.type==="ToolError"||g.is_error===true,m.push(...$e(g.output)),m.length===0&&typeof g.message=="string"&&g.message.length>0&&m.push({type:"content",content:{type:"text",text:g.message}}),m.length===0&&m.push(...$e(d));}else m.push(...$e(d));f=f||Mn(m),o.push({update:{sessionUpdate:"tool_call_update",toolCallId:u,status:f?"failed":"completed",content:m}});break}default:return null}return o.length>0?o:null}function a(p,r){let l=In[p]||"other",o=[],u=[],d=p;switch(p){case "ReadFile":{let m=r.path??r.file_path;d=`Read ${m||"file"}`,m&&u.push({path:m});break}case "ReadMediaFile":{let m=r.path??r.file_path;d=`Read media ${m||"file"}`,m&&u.push({path:m});break}case "WriteFile":{let m=r.path??r.file_path;d=`Write ${m||"file"}`,m&&(u.push({path:m}),typeof r.content=="string"&&o.push({type:"diff",path:m,oldText:null,newText:r.content}));break}case "StrReplaceFile":{let m=r.path??r.file_path;d=`Edit ${m||"file"}`,m&&u.push({path:m});break}case "Shell":d=r.command?`\`${r.command}\``:"Run command";break;case "Glob":d=`Find ${r.pattern||"files"}`,r.path&&u.push({path:r.path});break;case "Grep":d=`grep "${r.pattern||""}"`,r.path&&u.push({path:r.path});break;case "SearchWeb":d=r.query?`"${r.query}"`:"Web search";break;case "FetchURL":d=r.url?`Fetch ${r.url}`:"Web fetch";break;case "Task":d=r.description||"Subagent task";break;case "Think":d=r.thought||"Thinking";break;case "CreateSubagent":d=r.name?`Subagent: ${r.name}`:"Create subagent";break;case "SetTodoList":d="Update todos";break;default:d=p;}return {title:d,kind:l,toolContent:o,locations:u}}}var Dn={read:"read",write:"edit",edit:"edit",multiedit:"edit",apply_patch:"edit",bash:"execute",glob:"search",grep:"search",list:"search",codesearch:"search",lsp:"search",webfetch:"fetch",websearch:"fetch",task:"think",batch:"think",plan_enter:"switch_mode",plan_exit:"switch_mode",todoread:"other",todowrite:"other",skill:"other",question:"other"};function Un(t){let e=/^data:([^;,]+)?((?:;[^,]+)*),(.*)$/s.exec(t);if(!e)return null;let n=e[1]||"",i=e[2]||"",c=e[3]||"";return /;base64/i.test(i)?{mimeType:n,data:c}:null}function Fn(t){if(typeof t!="string")return "pending";switch(t.toLowerCase()){case "in_progress":case "in-progress":case "running":return "in_progress";case "completed":case "done":case "cancelled":return "completed";default:return "pending"}}function Ln(t){return t==="high"||t==="medium"||t==="low"?t:"medium"}function pt(t){return Array.isArray(t)?t.map(e=>{if(!e||typeof e!="object")return null;let n=e.content;return typeof n!="string"||n.length===0?null:{content:n,status:Fn(e.status),priority:Ln(e.priority)}}).filter(e=>e!==null):[]}function Nn(t){if(!t||typeof t!="object")return null;let e=t,n=typeof e.mime=="string"?e.mime:"",i=typeof e.url=="string"?e.url:"";if(n.startsWith("image/")){if(i.length>0){let p=Un(i);return p?{type:"content",content:{type:"image",data:p.data,mimeType:p.mimeType||n}}:{type:"content",content:{type:"image",data:"",mimeType:n,uri:i}}}return null}return {type:"content",content:{type:"text",text:`[attachment] ${(typeof e.filename=="string"?e.filename:"")||"attachment"} (${n||"file"})`}}}function Bn(t,e){if(t==="error")return typeof e.error=="string"?e.error:null;if(typeof e.output=="string")return e.output;if(e.output===void 0||e.output===null)return null;try{return JSON.stringify(e.output)}catch{return String(e.output)}}function Kn(t,e){return t==="error"?"failed":t==="running"?"in_progress":t==="pending"?"pending":typeof e=="number"&&e!==0?"failed":"completed"}function Le(){return function(a){let p;try{p=JSON.parse(a);}catch{return null}if(!p||typeof p!="object")return null;let r=p.sessionID,l=[];switch(p.type){case "step_start":case "step_finish":return null;case "text":{let o=t(p);o&&l.push({sessionId:r,update:o});break}case "reasoning":{let o=e(p);o&&l.push({sessionId:r,update:o});break}case "tool_use":{let o=n(p);for(let u of o)l.push({sessionId:r,update:u});break}case "error":{let o=i(p);o&&l.push({sessionId:r,update:o});break}default:return null}return l.length>0?l:null};function t(s){let a=s.part?.text;return typeof a!="string"||a.length===0?null:{sessionUpdate:"agent_message_chunk",content:{type:"text",text:a}}}function e(s){let a=s.part?.text;return typeof a!="string"||a.length===0?null:{sessionUpdate:"agent_thought_chunk",content:{type:"text",text:a}}}function n(s){let a=s.part;if(!a)return [];let p=typeof a.callID=="string"?a.callID:"";if(p.length===0)return [];let r=typeof a.tool=="string"?a.tool.toLowerCase():"",l=typeof a.state=="object"&&a.state?a.state:{},o=typeof l.input=="object"&&l.input?l.input:{},u=l.status,d=l.title??l.metadata?.description??r,m=l.metadata?.exit,{kind:f,content:g,locations:h}=c(r,o),v=[];if(v.push({sessionUpdate:"tool_call",toolCallId:p,title:d,kind:f,status:"pending",rawInput:o,content:g,locations:h}),r==="todowrite"){let k=pt(o.todos);if(k.length===0&&typeof l.output=="string")try{k=pt(JSON.parse(l.output));}catch{}k.length>0&&v.push({sessionUpdate:"plan",entries:k});}let x=Kn(u,m);if(x==="pending")return v;let y=Bn(u,l),w=[];if(typeof y=="string"&&y.length>0&&w.push({type:"content",content:{type:"text",text:x==="failed"?`\`\`\`
${y}
\`\`\``:y}}),Array.isArray(l.attachments))for(let k of l.attachments){let b=Nn(k);b&&w.push(b);}return v.push({sessionUpdate:"tool_call_update",toolCallId:p,status:x,content:w}),v}function i(s){let a=s.error?.name??"Error",p=s.error?.data?.message??s.error?.message??"Unknown error";return {sessionUpdate:"agent_message_chunk",content:{type:"text",text:`\u274C ${a}: ${p}`}}}function c(s,a){let p=Dn[s]||"other",r=[],l=[];switch(s){case "read":{let o=a.filePath??a.path;if(o){let u=a.offset;l.push({path:o,line:typeof u=="number"&&Number.isFinite(u)?Math.max(0,u-1):void 0});}break}case "write":{let o=a.filePath??a.path;o&&(l.push({path:o}),typeof a.content=="string"&&r.push({type:"diff",path:o,oldText:null,newText:a.content}));break}case "edit":case "multiedit":{let o=a.filePath??a.path;o&&(l.push({path:o}),s==="edit"&&(a.oldString!==void 0||a.newString!==void 0)&&r.push({type:"diff",path:o,oldText:a.oldString??"",newText:a.newString??""}));break}case "apply_patch":break;case "bash":{let o=a.command;o&&a.description?r.push({type:"content",content:{type:"text",text:a.description}}):o&&r.push({type:"content",content:{type:"text",text:o}});break}case "glob":case "list":{let o=a.path;o&&l.push({path:o});break}case "grep":{let o=a.path;o&&l.push({path:o});break}case "codesearch":case "websearch":{let o=a.query;o&&r.push({type:"content",content:{type:"text",text:o}});break}case "webfetch":{let o=a.url;o&&r.push({type:"content",content:{type:"text",text:o}});break}case "task":{let o=a.description;o&&r.push({type:"content",content:{type:"text",text:o}});break}}return {kind:p,content:r,locations:l}}}var jn={Read:"read",read_file:"read",Write:"edit",Edit:"edit",write_file:"edit",edit_file:"edit",Bash:"execute",BashOutput:"execute",KillShell:"execute",shell:"execute",run_shell_command:"execute",WebFetch:"fetch",WebSearch:"fetch",brave_web_search:"fetch",Glob:"search",Grep:"search",LS:"search",list_directory:"search",Task:"think",TodoWrite:"other",ExitPlanMode:"switch_mode"};function ue(){let t=new Map,e=new Map;return function(o){let u;try{u=JSON.parse(o);}catch{return null}if(!u||typeof u!="object")return null;let d=u;if("_meta"in d||"_prompt"in d)return null;let m=d.session_id||void 0,f=[];switch(d.type){case "assistant":{let g=n(d);for(let h of g)f.push({sessionId:m,update:h});break}case "stream_event":{let g=i(d);for(let h of g)f.push({sessionId:m,update:h});break}case "user":{let g=c(d);for(let h of g)f.push({sessionId:m,update:h});break}case "system":case "result":return null;default:return null}return f.length>0?f:null};function n(l){let o=[],u=l.message?.content;if(!Array.isArray(u))return o;for(let d of u){let m=s(d);o.push(...m);}return o}function i(l){let o=[],u=l.event;if(!u)return o;switch(u.type){case "content_block_start":{let d=u.index??0,m=u.content_block;m&&(t.set(d,m),m.type==="tool_use"&&e.set(d,""));break}case "content_block_delta":{let d=u.index??0,m=u.delta,f=t.get(d);if(m?.type==="text_delta"&&m.text)o.push({sessionUpdate:"agent_message_chunk",content:{type:"text",text:m.text}});else if(m?.type==="thinking_delta"&&m.thinking)o.push({sessionUpdate:"agent_thought_chunk",content:{type:"text",text:m.thinking}});else if(m?.type==="input_json_delta"&&m.partial_json&&f?.type==="tool_use"){let g=e.get(d)||"";e.set(d,g+m.partial_json);}break}case "content_block_stop":{let d=u.index??0,m=t.get(d);if(m&&!(m.type==="text"&&m.text)){if(!(m.type==="thinking"&&m.thinking)){if(m.type==="tool_use"){let f=m,g=e.get(d)||"";e.delete(d);let h=f.input;if(g)try{h=JSON.parse(g);}catch{}let v={...f,input:h},x=a(v);x&&o.push(x);}else if(m.type==="tool_result"){let f=p(m);f&&o.push(f);}}}t.delete(d);break}}return o}function c(l){let o=l.message?.content,u=[];if(typeof o=="string")return u.push({sessionUpdate:"user_message_chunk",content:{type:"text",text:o}}),u;if(Array.isArray(o)){for(let d of o)if(d.type==="text")u.push({sessionUpdate:"user_message_chunk",content:{type:"text",text:d.text}});else if(d.type==="tool_result"){let m=p(d);m&&u.push(m);}}return u}function s(l){switch(l.type){case "text":return l.text?[{sessionUpdate:"agent_message_chunk",content:{type:"text",text:l.text}}]:[];case "thinking":return l.thinking?[{sessionUpdate:"agent_thought_chunk",content:{type:"text",text:l.thinking}}]:[];case "tool_use":{let o=a(l);return o?[o]:[]}case "tool_result":{let o=p(l);return o?[o]:[]}}}function a(l){let o=l.id,u=l.name,d=l.input;if(u==="TodoWrite"&&Array.isArray(d?.todos))return {sessionUpdate:"plan",entries:d.todos.map(v=>({content:v.content,status:v.status||"pending",priority:"medium"}))};let{title:m,kind:f,content:g,locations:h}=r(u,d||{});return {sessionUpdate:"tool_call",toolCallId:o,title:m,kind:f,status:"pending",rawInput:d,content:g,locations:h}}function p(l){let o=l.tool_use_id,u=l.is_error??false,d=l.content,m=[];if(typeof d=="string"&&d.length>0)m.push({type:"content",content:{type:"text",text:u?`\`\`\`
${d}
\`\`\``:d}});else if(Array.isArray(d)){for(let f of d)if(f.type==="text"){let g=f.text;m.push({type:"content",content:{type:"text",text:u?`\`\`\`
${g}
\`\`\``:g}});}}return {sessionUpdate:"tool_call_update",toolCallId:o,status:u?"failed":"completed",content:m}}function r(l,o){let u=jn[l]||"other",d=[],m=[],f=l;switch(l){case "Read":case "read_file":f=`Read ${o.file_path||o.absolute_path||"file"}`,(o.file_path||o.absolute_path)&&m.push({path:o.file_path||o.absolute_path});break;case "Write":case "write_file":f=`Write ${o.file_path||"file"}`,o.file_path&&(m.push({path:o.file_path}),d.push({type:"diff",path:o.file_path,oldText:null,newText:o.content||""}));break;case "Edit":case "edit_file":f=`Edit ${o.file_path||"file"}`,o.file_path&&m.push({path:o.file_path});break;case "Bash":case "shell":case "run_shell_command":f=o.command?`\`${o.command}\``:"Run command",o.description&&d.push({type:"content",content:{type:"text",text:o.description}});break;case "WebFetch":f=o.url?`Fetch ${o.url}`:"Web fetch";break;case "WebSearch":case "brave_web_search":f=o.query?`"${o.query}"`:"Web search";break;case "Glob":f=`Find ${o.pattern||"files"}`,o.path&&m.push({path:o.path});break;case "Grep":f=`grep "${o.pattern||""}"`;break;case "LS":case "list_directory":f=`List ${o.path||"directory"}`,o.path&&m.push({path:o.path});break;case "Task":f=o.description||"Subagent task";break;case "TodoWrite":f="Update todos";break;case "ExitPlanMode":f="Exit plan mode";break;default:f=l;}return {title:f,kind:u,content:d,locations:m}}}function ut(t){return ue()(t)}function M(t){switch(t){case "claude":return ce();case "codex":return le();case "gemini":return pe();case "qwen":return ue();case "kimi":return Fe();case "opencode":return Le();default:return ()=>null}}function Vn(t,e){let n=e.trim();return n?M(t)(n):null}function Wn(t,e){let n=[],i=e.split(`
`),c=M(t);for(let s of i){let a=s.trim();if(!a)continue;let p=c(a);p&&n.push(...p);}return n}function J(){return process.env.EVOLVE_GATEWAY_URL||"https://swarmkit-gateway-692833842999.us-central1.run.app"}function dt(){return `${J()}`}function mt(){return `${J()}/e2b`}function ft(t){return {"browser-use":{type:"http",url:`${J()}/browser_use/mcp`,headers:{"x-litellm-api-key":`Bearer ${t}`}}}}var A="EVOLVE_API_KEY",de="E2B_API_KEY",me="DAYTONA_API_KEY",fe="MODAL_TOKEN_ID",Ne="MODAL_TOKEN_SECRET",gt="claude",G=36e5,ht=4,Be=100,yt="/home/user/workspace",E=process.env.EVOLVE_DASHBOARD_URL||"https://dashboard.evolvingmachines.ai",wt=".evolve-sdk/observability/sessions",vt=100,xt=5e3,ge=3,Ke=1e3;function R(t){return t!==null&&typeof t=="object"&&"safeParse"in t&&typeof t.safeParse=="function"}function B(t){return JSON.stringify(zn(t,{target:"jsonSchema7"}),null,2)}function K(t){return JSON.stringify(t,null,2)}function kt(t,e=false){let n={};function i(c,s){for(let a of P.readdirSync(c)){let p=Y.join(c,a),r=s?`${s}/${a}`:a;P.statSync(p).isDirectory()?e&&i(p,r):n[r]=P.readFileSync(p);}}return i(t,""),n}function bt(t,e){for(let[n,i]of Object.entries(e)){let c=Y.join(t,n),s=Y.dirname(c);P.mkdirSync(s,{recursive:true});let a;i instanceof ArrayBuffer||i instanceof Uint8Array?a=Buffer.from(i):a=i,P.writeFileSync(c,a);}}function Jn(t){let e=t.replace(/^~/,process.env.HOME||"");if(!P.existsSync(e))throw new Error(`OAuth file not found: ${e}`);return P.readFileSync(e,"utf-8")}function ye(t){let e=t?.type??gt,n=O(e);if(t?.oauthToken){if(e!=="claude")throw new Error(`oauthToken is only supported for claude agent (Claude Max subscription), not ${e}. Use providerApiKey for ${e} instead.`);return {type:e,apiKey:t.oauthToken,isDirectMode:true,isOAuth:true,model:t.model,reasoningEffort:t.reasoningEffort}}if(t?.providerApiKey){let a=t.providerBaseUrl??process.env[n.baseUrlEnv]??n.defaultBaseUrl;return {type:e,apiKey:t.providerApiKey,baseUrl:a,isDirectMode:true,model:t.model,reasoningEffort:t.reasoningEffort}}if(t?.apiKey)return {type:e,apiKey:t.apiKey,isDirectMode:false,model:t.model,reasoningEffort:t.reasoningEffort};let i=process.env[A];if(i)return {type:e,apiKey:i,isDirectMode:false,model:t?.model,reasoningEffort:t?.reasoningEffort};if(n.providerEnvMap){let p=(t?.model??n.defaultModel)?.split("/")[0],r=p?n.providerEnvMap[p]:void 0,l=r?process.env[r.keyEnv]:void 0;if(l){let o=process.env[n.baseUrlEnv]??n.defaultBaseUrl;return {type:e,apiKey:l,baseUrl:o,isDirectMode:true,model:t?.model,reasoningEffort:t?.reasoningEffort}}}let c=process.env[n.apiKeyEnv];if(c){let a=process.env[n.baseUrlEnv]??n.defaultBaseUrl;return {type:e,apiKey:c,baseUrl:a,isDirectMode:true,model:t?.model,reasoningEffort:t?.reasoningEffort}}if(n.oauthEnv){let a=process.env[n.oauthEnv];if(a){if(n.oauthFileName){let p=Jn(a);return {type:e,apiKey:"__oauth_file__",isDirectMode:true,isOAuth:true,oauthFileContent:p,model:t?.model,reasoningEffort:t?.reasoningEffort}}return {type:e,apiKey:a,isDirectMode:true,isOAuth:true,model:t?.model,reasoningEffort:t?.reasoningEffort}}}let s=n.oauthEnv?n.oauthFileName?`, or ${n.oauthEnv}`:`, oauthToken, or ${n.oauthEnv}`:"";throw new Error(`No API key found for ${e}. Set apiKey (gateway), providerApiKey (direct)${s}, or ${A} / ${n.apiKeyEnv} env var.`)}async function je(){let t=process.env[de];if(t)try{let{createE2BProvider:s}=await import('@evolvingmachines/e2b');return s({apiKey:t})}catch(s){let a=s;throw a.message?.includes("Cannot find module")||a.message?.includes("MODULE_NOT_FOUND")?new Error(`${de} is set but @evolvingmachines/e2b failed to load.
Try reinstalling: npm install @evolvingmachines/sdk`):a}let e=process.env[me];if(e)try{let{createDaytonaProvider:s}=await import('@evolvingmachines/daytona');return s({apiKey:e})}catch(s){let a=s;throw a.message?.includes("Cannot find module")||a.message?.includes("MODULE_NOT_FOUND")?new Error(`${me} is set but @evolvingmachines/daytona failed to load.
Try installing: npm install @evolvingmachines/daytona`):a}let n=process.env[fe],i=process.env[Ne];if(n&&i)try{let{createModalProvider:s}=await import('@evolvingmachines/modal');return s({tokenId:n,tokenSecret:i})}catch(s){let a=s;throw a.message?.includes("Cannot find module")||a.message?.includes("MODULE_NOT_FOUND")?new Error(`${fe} is set but @evolvingmachines/modal failed to load.
Try installing: npm install @evolvingmachines/modal`):a}let c=process.env[A];if(c)try{let{createE2BProvider:s}=await import('@evolvingmachines/e2b');return process.env.E2B_API_URL=mt(),s({apiKey:c})}catch(s){let a=s;throw a.message?.includes("Cannot find module")||a.message?.includes("MODULE_NOT_FOUND")?new Error(`${A} is set but @evolvingmachines/e2b failed to load.
Try reinstalling: npm install @evolvingmachines/sdk`):a}throw new Error(`No sandbox provider configured. Either:
1. Set ${A} environment variable (recommended, get key at https://dashboard.evolvingmachines.ai)
2. Set ${de} environment variable (direct E2B access, get key at https://e2b.dev)
3. Set ${me} environment variable (direct Daytona access, get key at https://app.daytona.io)
4. Set ${fe} and ${Ne} environment variables (direct Modal access, get tokens at https://modal.com/settings/tokens)
5. Pass sandbox explicitly: .withSandbox(provider)`)}function Gn(t){return new Promise(e=>setTimeout(e,t))}async function _(t,e,n=0){let i=Yn(e),c=e?.onItemRetry,s=null,a=0,p=i.backoffMs;for(;a<i.maxAttempts;){if(a++,s=await t(a),!i.retryOn(s))return s;if(a>=i.maxAttempts)break;if(c){let r=s.error??"Unknown error";c(n,a,r);}await Gn(p),p*=i.backoffMultiplier;}return s}function Yn(t){return {maxAttempts:t?.maxAttempts??3,backoffMs:t?.backoffMs??1e3,backoffMultiplier:t?.backoffMultiplier??2,retryOn:t?.retryOn??(e=>e.status==="error")}}var Ct=`## FILESYSTEM INSTRUCTIONS:

You are running in a sandbox environment.

The file system is mounted at \`{{workingDir}}/\`

Your present working directory: \`{{workingDir}}/\`

IMPORTANT - Directory structure:
\`\`\`
{{workingDir}}/
\u251C\u2500\u2500 context/   # Input files (read-only) provided by the user
\u251C\u2500\u2500 scripts/   # Your code goes here
\u251C\u2500\u2500 temp/      # Scratch space
\u2514\u2500\u2500 output/    # Where you can save final deliverables
\`\`\`

### OUTPUT RULES:

The \`output/\` folder is how you deliver files to the user\u2014the SDK retrieves everything from there.

Use your best judgment:
- **Questions, explanations, conversation** \u2192 respond in chat
- **Artifacts** (files, documents, code, charts, data) \u2192 save to \`output/\`

Examples:
- "What is a binary search?" \u2192 chat
- "Summarize this document" \u2192 chat
- "Create an Excel report" \u2192 \`output/sales_report.xlsx\`
- "Build an HTML dashboard" \u2192 \`output/dashboard.html\`
- "Generate a bar chart" \u2192 \`output/revenue_chart.png\`
- "Write a Python script" \u2192 \`output/parser.py\`
- "Convert this to JSON" \u2192 \`output/data.json\`
`;var St=`## FILESYSTEM INSTRUCTIONS:

You are running in a sandbox environment.

The file system is mounted at \`{{workingDir}}/\`

Your present working directory: \`{{workingDir}}/\`

IMPORTANT - Directory structure:
\`\`\`
{{workingDir}}/
\u251C\u2500\u2500 repo/      # Code repository
\u251C\u2500\u2500 context/   # Input files (read-only) provided by the user
\u251C\u2500\u2500 scripts/   # Your code goes here
\u251C\u2500\u2500 temp/      # Scratch space
\u2514\u2500\u2500 output/    # Final deliverables
\`\`\`

### OUTPUT RULES:

The \`output/\` folder is how you deliver files to the user\u2014the SDK retrieves everything from there.

Use your best judgment:
- **Questions, explanations, conversation** \u2192 respond in chat
- **Artifacts** (files, documents, code, charts, data) \u2192 save to \`output/\`

Examples:
- "What is a binary search?" \u2192 chat
- "Summarize this document" \u2192 chat
- "Create an Excel report" \u2192 \`output/sales_report.xlsx\`
- "Build an HTML dashboard" \u2192 \`output/dashboard.html\`
- "Generate a bar chart" \u2192 \`output/revenue_chart.png\`
- "Write a Python script" \u2192 \`output/parser.py\`
- "Convert this to JSON" \u2192 \`output/data.json\`
`;var _t=`## SYSTEM PROMPT

{{systemPrompt}}`;var Tt=`## STRUCTURED OUTPUT

Your final result MUST be saved to \`output/result.json\` following this schema:

\`\`\`json
{{schema}}
\`\`\`

You are free to:
- Reason through the problem step by step
- Read and analyze context files
- Use any available tools
- Process incrementally
- Create intermediate files in \`temp/\` or \`scripts/\`

But your final \`output/result.json\` MUST conform to the schema above.

### OUTPUT RESULTS (DELIVERABLES) MUST BE WRITTEN to \`output/result.json\` as files.
### Never just state results as text.`;var Et=`### 1. YOUR ROLE: BEST OF N JUDGE

You are a judge. {{candidateCount}} AI workers attempted the same task independently. Your job is to analyze their solution attempts and pick the best one based on the evaluation criteria below.

### 2. CONTEXT STRUCTURE

\`\`\`
{{fileTree}}
\`\`\`

### 3. YOUR EVALUATION CRITERIA

You must judge their work based on:

\`\`\`
{{criteria}}
\`\`\`

### 4. YOUR PROCESS

1. Read \`worker_task/\` to understand the task:
   - Review the worker system prompt and task prompt
   - Check the expected output schema (if present)
   - Examine the worker input files in \`input/\`
2. Carefully review EACH solution attempt in \`candidate_i/\`
3. Compare outputs against the evaluation criteria
4. Reason through your findings \u2014 perform all necessary evidence-based analyses and verifications before deciding
5. Pick the best candidate (0-indexed)

**IMPORTANT:** Be thorough. Do not skip steps. Your judgment must be evidence-based \u2014 cite specific files, outputs, or discrepancies to justify your decision.
`;var Rt=`### 1. YOUR ROLE: OUTPUT VERIFIER

You are a quality verifier. An AI worker produced output for a task. Your job is to verify whether the output meets the specified quality criteria.

### 2. CONTEXT STRUCTURE

\`\`\`
{{fileTree}}
\`\`\`

### 3. VERIFICATION CRITERIA

The output must satisfy:

\`\`\`
{{criteria}}
\`\`\`

### 4. YOUR PROCESS

1. Read \`worker_task/\` to understand what was asked:
   - Review the worker system prompt (if present)
   - Review the task prompt
   - Check the expected output schema (if present)
   - Examine any input files in \`input/\`
2. Carefully review the worker's output in \`worker_output/\`
3. Evaluate against the verification criteria
4. Reason through your findings
5. Make your decision

**IMPORTANT:** Be thorough and fair. Cite specific evidence. If the output generally achieves the goal with minor issues, consider passing. Only fail if there are significant problems that violate the criteria.

If failing, provide specific, actionable feedback explaining what needs to be fixed.
`;var Pt=`### CONTEXT STRUCTURE

\`\`\`
{{fileTree}}
\`\`\`

Examine all files within each item folder before producing your output.
`;var Ot="Evaluate the candidates and select the best one. You MUST save your decision to the file `output/result.json`.\n";var It="Verify the worker output against the criteria. You MUST save your decision to the file `output/result.json`.\n";var Mt=`{{originalPrompt}}

## IMPORTANT: Previous Attempt Failed Verification

Your previous attempt did not pass quality verification. Please address this feedback:

{{feedback}}

Make sure your output addresses all the feedback points above.
`;var At=Ct,$t=St,Dt=_t,Ut=Tt,Ve=Et,Ft=Ot,We=Rt,Lt=It,Nt=Pt,ze=Mt;function I(t,e){let n=t;for(let[i,c]of Object.entries(e))n=n.replace(new RegExp(`\\{\\{${i}\\}\\}`,"g"),c);return n}function Je(t){let e=t.mode==="swe"?$t:At,n=I(e,{workingDir:t.workingDir}).trim();if(t.systemPrompt&&(n+=`


${I(Dt,{systemPrompt:t.systemPrompt}).trim()}`),t.schema){let i=R(t.schema)?B(t.schema):K(t.schema);n+=`


${I(Ut,{schema:i}).trim()}`;}return n}function we(t){let e=[...new Set(Object.keys(t).map(r=>r.split("/")[0]))].sort((r,l)=>r==="worker_task"?-1:l==="worker_task"?1:r.localeCompare(l));if(!e.length)return `context/
  (empty)`;let n="worker_task/system_prompt.txt"in t,i="worker_task/schema.json"in t,c=Object.keys(t).some(r=>r.startsWith("worker_task/input/")),s=[];e.forEach((r,l)=>{let o=l===e.length-1,u=o?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ",d=o?"    ":"\u2502   ";if(r==="worker_task"){s.push({line:`${u}${r}/`,comment:"task given to worker"});let m=[];n&&m.push({name:"system_prompt.txt",comment:"worker system prompt"}),m.push({name:"user_prompt.txt",comment:"worker task prompt"}),i&&m.push({name:"schema.json",comment:"expected output schema"}),c&&m.push({name:"input/",comment:"worker input files"}),m.forEach((f,g)=>{let v=g===m.length-1?"\u2514\u2500\u2500 ":"\u251C\u2500\u2500 ";s.push({line:`${d}${v}${f.name}`,comment:f.comment});});}else if(r.startsWith("candidate_")){let m=r.replace("candidate_","");s.push({line:`${u}${r}/`,comment:`worker ${m} solution`});}else if(r==="worker_output")s.push({line:`${u}${r}/`,comment:"output to verify"});else if(r.startsWith("item_")){let m=r.replace("item_","");s.push({line:`${u}${r}/`,comment:`input ${m}`});}else s.push({line:`${u}${r}/`,comment:""});});let a=Math.max(...s.map(r=>r.line.length)),p=["context/"];for(let r of s)if(r.comment){let l=" ".repeat(a-r.line.length+3);p.push(`${r.line}${l}# ${r.comment}`);}else p.push(r.line);return p.join(`
`)}var Bt=join(homedir(),wt),H=class{tag;timestamp;provider;agent;model;sandboxId;apiKey;dashboardUrl;localFilePath;observability;parser;isClosed=false;metaWritten=false;localQueue=Promise.resolve();dirReady=mkdir(Bt,{recursive:true}).catch(()=>{});eventBuffer=[];dashboardQueue=Promise.resolve();flushTimer;constructor(e){this.validateConfig(e),this.provider=e.provider,this.agent=e.agent,this.model=e.model,this.sandboxId=e.sandboxId,this.apiKey=e.apiKey,this.dashboardUrl=E,this.observability=e.observability;let n=e.tagPrefix||"evolve";this.tag=`${n}-${randomBytes(8).toString("hex")}`,this.timestamp=new Date().toISOString();let i=this.timestamp.replace(/[:.]/g,"-"),c=`${this.tag}_${this.provider}_${this.sandboxId}_${this.agent}_${i}.jsonl`;this.localFilePath=join(Bt,c),this.parser=M(e.agent);}getTag(){return this.tag}getTimestamp(){return this.timestamp}writePrompt(e){this.isClosed||this.write({_prompt:{text:e}});}writeEventParsed(e,n){if(!this.isClosed&&(this.writeLocalLine(e),this.apiKey&&n))for(let i of n)this.bufferForDashboard(i);}writeEvent(e){if(!this.isClosed&&(this.writeLocalLine(e),this.apiKey)){let n=this.parser(e);if(n)for(let i of n)this.bufferForDashboard(i);}}async flush(){await this.localQueue,await this.dashboardQueue,this.apiKey&&this.eventBuffer.length>0&&(this.flushDashboard(),await this.dashboardQueue);}async close(){this.isClosed||(this.isClosed=true,this.flushTimer&&(clearTimeout(this.flushTimer),this.flushTimer=void 0),this.write({_sessionEnd:{timestamp:new Date().toISOString()}}),await this.flush());}writeLocalLine(e){this.metaWritten||this.writeMeta();let n=e.endsWith(`
`)?e:e+`
`;this.localQueue=this.localQueue.then(()=>this.appendLocal(n)).catch(()=>{});}bufferForDashboard(e){this.eventBuffer.push(e),this.scheduleFlush();}write(e){this.metaWritten||this.writeMeta();let n=JSON.stringify(e)+`
`;this.localQueue=this.localQueue.then(()=>this.appendLocal(n)).catch(()=>{}),this.apiKey&&(this.eventBuffer.push(e),this.scheduleFlush());}writeMeta(){let e={_meta:{tag:this.tag,provider:this.provider,agent:this.agent,model:this.model,sandbox_id:this.sandboxId,timestamp:this.timestamp,...this.filterUndefined(this.observability)}},n=JSON.stringify(e)+`
`;this.localQueue=this.localQueue.then(()=>this.appendLocal(n)).catch(()=>{}),this.apiKey&&this.eventBuffer.push(e),this.metaWritten=true;}async appendLocal(e){try{await this.dirReady,await appendFile(this.localFilePath,e,"utf-8");}catch(n){console.debug("[SessionLogger] Local write failed:",n);}}scheduleFlush(){if(this.eventBuffer.length>=vt){this.flushDashboard();return}!this.flushTimer&&!this.isClosed&&(this.flushTimer=setTimeout(()=>{this.flushTimer=void 0,this.flushDashboard();},xt));}flushDashboard(){if(!this.apiKey||this.eventBuffer.length===0)return;let e=this.eventBuffer.splice(0);this.dashboardQueue=this.dashboardQueue.then(()=>this.sendToDashboard(e)).catch(()=>{});}async sendToDashboard(e){let n={tag:this.tag,provider:this.provider,agent:this.agent,model:this.model,sandboxId:this.sandboxId,timestamp:this.timestamp,...this.filterUndefined(this.observability),events:e};for(let i=1;i<=ge;i++)try{let c=await fetch(`${this.dashboardUrl}/api/sessions/ingest`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(n),signal:AbortSignal.timeout(1e4)});if(c.ok)return;if(c.status===429||c.status===401||c.status>=500){if(i===ge){console.debug(`[SessionLogger] Dashboard ${c.status} after ${i} retries, requeueing`),this.requeueEvents(e);return}await this.delay(Ke*i);continue}console.debug(`[SessionLogger] Dashboard ${c.status}, dropping events`);return}catch(c){i===ge?(console.debug("[SessionLogger] Dashboard sync failed after retries, requeueing:",c),this.requeueEvents(e)):await this.delay(Ke*i);}}requeueEvents(e){this.eventBuffer.unshift(...e);}validateConfig(e){if(e.apiKey&&!E.startsWith("https://")&&!E.includes("localhost")&&!E.includes("127.0.0.1"))throw new Error("Dashboard URL must use HTTPS when API key is provided")}delay(e){return new Promise(n=>setTimeout(n,e))}filterUndefined(e){return e?Object.fromEntries(Object.entries(e).filter(([,n])=>n!==void 0)):{}}};var ve="COMPOSIO_API_KEY";function jt(t){return new Composio({apiKey:process.env[ve]})}function Ge(t){if(!t?.trim())throw new Error("userId is required and cannot be empty")}async function xe(t,e,n){Ge(t);let i=jt(),c={};return e?.toolkits&&(c.toolkits=e.toolkits),e?.tools&&(c.tools=e.tools),e?.authConfigs&&(c.authConfigs=e.authConfigs),e?.connectedAccounts&&(c.connectedAccounts=e.connectedAccounts),e?.manageConnections!==void 0&&(c.manageConnections=e.manageConnections),await i.create(t,Object.keys(c).length>0?c:void 0)}async function Vt(t,e,n,i){Ge(t);let c=jt(),p=(await c.toolkits.get(e)).authConfigDetails?.find(r=>r.mode==="API_KEY");if(!p)throw new Error(`Toolkit "${e}" does not support API key authentication. Get an OAuth URL via Evolve.composio.auth() instead.`);await c.connectedAccounts.initiate(t,p.name,{config:AuthScheme.APIKey({api_key:n})});}async function Ye(t,e){if(Ge(t),e?.keys)for(let[i,c]of Object.entries(e.keys))try{await Vt(t,i,c);}catch(s){throw new Error(`Failed to create API key connection for "${i}": ${s.message}`)}let n=await xe(t,{toolkits:e?.toolkits,tools:e?.tools,authConfigs:e?.authConfigs,connectedAccounts:e?.connectedAccounts,manageConnections:e?.manageConnections});return {url:n.mcp.url,headers:n.mcp.headers}}function Wt(t){if(!t?.trim())throw new Error("userId is required and cannot be empty")}function mo(){return new Composio({apiKey:process.env[ve]})}async function zt(t,e){Wt(t);let i=await(await xe(t,{manageConnections:false})).authorize(e);return {url:i.redirectUrl,connectionId:i.id}}async function Jt(t,e){let n=await He(t),i={};for(let c of n)i[c.toolkit]=c.connected;return e?i[e]??false:i}async function He(t){return Wt(t),(await mo().connectedAccounts.list({userIds:[t],statuses:["ACTIVE"]})).items.map(i=>({toolkit:i.toolkit.slug,connected:i.status==="ACTIVE",accountId:i.id}))}var qe={auth:zt,status:Jt,connections:He};promisify(exec);var et=promisify(execFile),Ht=Symbol.for("evolve:awsSdkCache"),qt=Symbol.for("evolve:s3ClientCache");var So=3600,_o=["node_modules","__pycache__","*.pyc",".cache",".npm",".pip",".venv","venv"];function To(t){if(t.startsWith("s3://")){let c=t.slice(5),s=c.indexOf("/");return s===-1?{bucket:c,prefix:""}:{bucket:c.slice(0,s),prefix:c.slice(s+1).replace(/\/+$/,"")}}let e=new URL(t),n=e.hostname,i=e.pathname.split("/").filter(Boolean);if(n.includes(".s3.")&&n.endsWith(".amazonaws.com"))return {bucket:n.split(".s3.")[0],prefix:i.join("/")};if(i.length===0)throw new Error(`Invalid storage URL: no bucket in path. Expected https://endpoint/bucket/prefix, got ${t}`);return {bucket:i[0],prefix:i.slice(1).join("/"),endpoint:`${e.protocol}//${e.host}`}}function Ce(t,e,n,i){if(!t?.url&&!t?.bucket){if(!e)throw new Error("Storage requires either a URL (BYOK mode) or gateway API key. Use .withStorage({ url: 's3://bucket/prefix' }) or configure EVOLVE_API_KEY for gateway mode.");return {bucket:"",prefix:"",region:t?.region||"us-east-1",mode:"gateway",gatewayUrl:n,gatewayApiKey:i}}let c=t?.bucket||"",s=t?.prefix||"",a=t?.endpoint;if(t?.url){let p=To(t.url);c=c||p.bucket,s=s||p.prefix,a=a||p.endpoint;}if(!c)throw new Error("Storage bucket is required. Provide url (s3://bucket/prefix) or explicit bucket name.");return {bucket:c,prefix:s,region:t?.region||process.env.AWS_REGION||"us-east-1",endpoint:a,credentials:t?.credentials,mode:"byok"}}function Zt(t){if(t.includes(".."))throw new Error(`settingsDir must not contain '..': ${t}`);let e;if(t.startsWith("~/"))e=t.slice(2);else if(t.startsWith("/home/user/"))e=t.slice(11);else if(t.startsWith("."))e=t;else throw new Error(`Unexpected settingsDir: ${t}. Expected ~/ or /home/user/ prefix.`);if(!e||e.startsWith("/"))throw new Error(`settingsDir resolves to invalid path: ${t}`);return e}function Eo(t){if(t.includes(".."))throw new Error(`workingDir must not contain '..': ${t}`);if(!t.startsWith("/home/user/"))throw new Error(`Unexpected workingDir: ${t}. Must start with /home/user/.`);let e=t.slice(11).replace(/\/+$/,"");if(!e||e.startsWith("/")||e.includes("//"))throw new Error(`workingDir resolves to invalid path: ${t}`);return e}function ke(t){return "'"+t.replace(/'/g,"'\\''")+"'"}function Ro(t,e){let n=O(t),i=Eo(e),c=n.checkpointDirs?.length?n.checkpointDirs.map(p=>Zt(p)):[Zt(n.mcpConfig.settingsDir)],s=[..._o.map(p=>`--exclude=${ke(p)}`),`--exclude=${ke(i+"/temp")}`].join(" "),a=[ke(i+"/"),...c.map(p=>ke(p+"/"))].join(" ");return [`tar -czf /tmp/evolve-ckpt.tar.gz -C /home/user ${s} ${a}`,"sha256sum /tmp/evolve-ckpt.tar.gz | awk '{print $1}'"].join(" && ")}async function V(){let t=globalThis[Ht];if(t)return t;let e="@aws-sdk/client-s3",n="@aws-sdk/s3-request-presigner";try{let[i,c]=await Promise.all([Function("m","return import(m)")(e),Function("m","return import(m)")(n)]);return globalThis[Ht]={s3:i,presigner:c},{s3:i,presigner:c}}catch{throw new Error("Storage requires @aws-sdk/client-s3 and @aws-sdk/s3-request-presigner. Install: npm i @aws-sdk/client-s3 @aws-sdk/s3-request-presigner")}}async function Z(t){let e=t.credentials?`${t.credentials.accessKeyId}:${t.credentials.secretAccessKey.slice(-4)}`:"env",n=`${t.bucket}:${t.region}:${t.endpoint||""}:${e}`,i=globalThis[qt];if(i?.key===n)return i.client;let{s3:c}=await V(),s=new c.S3Client({region:t.region,...t.endpoint&&{endpoint:t.endpoint,forcePathStyle:true},...t.credentials&&{credentials:t.credentials}});return globalThis[qt]={client:s,key:n},s}async function an(t,e,n){let{s3:i,presigner:c}=await V(),s=await Z(t),a=n==="put"?new i.PutObjectCommand({Bucket:t.bucket,Key:e,ContentType:"application/gzip"}):new i.GetObjectCommand({Bucket:t.bucket,Key:e});return c.getSignedUrl(s,a,{expiresIn:So})}async function Qt(t,e){let{s3:n}=await V(),i=await Z(t);try{return await i.send(new n.HeadObjectCommand({Bucket:t.bucket,Key:e})),!0}catch(c){let s=c?.name||c?.message||"";if(c?.$metadata?.httpStatusCode===404||s==="NotFound"||s==="NoSuchKey")return  false;throw c}}async function cn(t,e){let{s3:n}=await V(),s=await(await(await Z(t)).send(new n.GetObjectCommand({Bucket:t.bucket,Key:e}))).Body?.transformToString();if(!s)throw new Error(`Empty response from S3 key: ${e}`);return JSON.parse(s)}async function Po(t,e,n){let{s3:i}=await V();await(await Z(t)).send(new i.PutObjectCommand({Bucket:t.bucket,Key:e,Body:JSON.stringify(n,null,2),ContentType:"application/json"}));}function ln(t,e){return `${t.prefix?`${t.prefix}/`:""}data/${e}/archive.tar.gz`}function pn(t,e){return `${t.prefix?`${t.prefix}/`:""}checkpoints/${e}.json`}function Oo(){let t=Date.now().toString(36),e=Math.random().toString(36).slice(2,10);return `ckpt_${t}_${e}`}async function un(t,e,n,i){let c=await fetch(`${t.gatewayUrl}/api/checkpoints/presign`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.gatewayApiKey}`},body:JSON.stringify({tag:e,hash:n,action:i})});if(!c.ok){let s=await c.text().catch(()=>"");throw new Error(`Gateway presign failed (${c.status}): ${s}`)}return c.json()}async function Io(t,e){let n=await fetch(`${t.gatewayUrl}/api/checkpoints`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.gatewayApiKey}`},body:JSON.stringify(e)});if(!n.ok){let i=await n.text().catch(()=>"");throw new Error(`Gateway checkpoint create failed (${n.status}): ${i}`)}return n.json()}async function Mo(t,e){let n=await fetch(`${t.gatewayUrl}/api/checkpoints/${encodeURIComponent(e)}`,{method:"GET",headers:{Authorization:`Bearer ${t.gatewayApiKey}`}});if(!n.ok){if(n.status===404)throw new Error(`Checkpoint ${e} not found`);let i=await n.text().catch(()=>"");throw new Error(`Gateway checkpoint get failed (${n.status}): ${i}`)}return n.json()}async function tt(t,e,n,i,c){let s=new Date().toISOString(),a=Ro(n,i),p=await t.commands.run(a,{timeoutMs:12e4});if(p.exitCode!==0)throw new Error(`Checkpoint tar failed: ${p.stderr}`);let r=p.stdout.trim().split(`
`).pop()?.trim();if(!r||r.length!==64)throw new Error(`Invalid checkpoint hash: ${r}`);let l=await t.commands.run("stat -c '%s' /tmp/evolve-ckpt.tar.gz 2>/dev/null || stat -f '%z' /tmp/evolve-ckpt.tar.gz",{timeoutMs:1e4}),o=parseInt(l.stdout.trim(),10),u=Number.isNaN(o)?void 0:o,d;try{if(e.mode==="byok"){let m=ln(e,r);if(!await Qt(e,m)){let h=await an(e,m,"put"),v=await t.commands.run(`curl -sf -X PUT -H "Content-Type: application/gzip" --upload-file /tmp/evolve-ckpt.tar.gz "${h}"`,{timeoutMs:3e5});if(v.exitCode!==0)throw new Error(`Checkpoint upload failed: ${v.stderr}`);if(!await Qt(e,m))throw new Error("Checkpoint upload verification failed (HeadObject)")}d=Oo();let g={id:d,hash:r,tag:c.tag,timestamp:s,sizeBytes:u,agentType:n,model:c.model,workspaceMode:c.workspaceMode,parentId:c.parentId,comment:c.comment,sandboxId:t.sandboxId};await Po(e,pn(e,d),g);}else {let m=await un(e,c.tag,r,"put");if(!m.alreadyExists){let g=await t.commands.run(`curl -sf -X PUT -H "Content-Type: application/gzip" --upload-file /tmp/evolve-ckpt.tar.gz "${m.url}"`,{timeoutMs:3e5});if(g.exitCode!==0)throw new Error(`Checkpoint upload failed: ${g.stderr}`)}d=(await Io(e,{tag:c.tag,hash:r,sizeBytes:u??0,agentType:n,model:c.model,workspaceMode:c.workspaceMode,parentId:c.parentId,comment:c.comment})).id;}}finally{await t.commands.run("rm -f /tmp/evolve-ckpt.tar.gz",{timeoutMs:1e4});}return {id:d,hash:r,tag:c.tag,timestamp:s,sizeBytes:u,agentType:n,model:c.model,workspaceMode:c.workspaceMode,parentId:c.parentId,comment:c.comment}}async function dn(t,e,n){let i=await ot(e,n),c=i.hash,s={agentType:i.agentType,workspaceMode:i.workspaceMode},a=await hn(e,i),p=await t.commands.run(`curl -sf -o /tmp/evolve-restore.tar.gz "${a}" && sha256sum /tmp/evolve-restore.tar.gz | awk '{print $1}'`,{timeoutMs:3e5});if(p.exitCode!==0)throw new Error(`Checkpoint download failed: ${p.stderr}`);let r=p.stdout.trim().split(`
`).pop()?.trim();if(r!==c)throw await t.commands.run("rm -f /tmp/evolve-restore.tar.gz",{timeoutMs:1e4}),new Error(`Checkpoint integrity check failed (expected ${c}, got ${r})`);let l=await t.commands.run("tar -xzf /tmp/evolve-restore.tar.gz -C /home/user && rm -f /tmp/evolve-restore.tar.gz",{timeoutMs:12e4});if(l.exitCode!==0)throw new Error(`Checkpoint extraction failed: ${l.stderr}`);return s}function mn(t,e){let n=e?.gatewayApiKey||process.env.EVOLVE_API_KEY,i=e?.gatewayUrl||E,c=!t.url&&!t.bucket&&!!n;return Ce(t,c,i,n)}async function fn(t,e){let{s3:n}=await V(),i=await Z(t),s=`${t.prefix?`${t.prefix}/`:""}checkpoints/`,a=[],p;do{let d={Bucket:t.bucket,Prefix:s,...p&&{ContinuationToken:p}},m=await i.send(new n.ListObjectsV2Command(d));if(m.Contents)for(let f of m.Contents)f.Key?.endsWith(".json")&&f.LastModified&&a.push({key:f.Key,lastModified:f.LastModified});p=m.IsTruncated?m.NextContinuationToken:void 0;}while(p);if(a.length===0)return [];a.sort((d,m)=>{let f=m.lastModified.getTime()-d.lastModified.getTime();return f!==0?f:m.key<d.key?-1:m.key>d.key?1:0});let l=!!e?.tag?a:e?.limit?a.slice(0,e.limit):a,u=(await Promise.all(l.map(async d=>{try{return await cn(t,d.key)}catch{return null}}))).filter(d=>d!==null);return e?.tag&&(u=u.filter(d=>d.tag===e.tag)),e?.limit&&u.length>e.limit&&(u=u.slice(0,e.limit)),u}async function gn(t,e){let n=new URLSearchParams;e?.limit&&n.set("limit",String(e.limit)),e?.tag&&n.set("tag",e.tag);let i=`${t.gatewayUrl}/api/checkpoints${n.toString()?`?${n}`:""}`,c=await fetch(i,{method:"GET",headers:{Authorization:`Bearer ${t.gatewayApiKey}`}});if(!c.ok){let s=await c.text().catch(()=>"");throw new Error(`Gateway list checkpoints failed (${c.status}): ${s}`)}return c.json()}function Ao(t){return t&&t>0?Math.min(t,500):100}async function nt(t,e){return t.mode==="byok"?(await fn(t,{limit:1,tag:e?.tag}))[0]??null:(await gn(t,{limit:1,tag:e?.tag}))[0]??null}async function ot(t,e){if(t.mode==="byok"){let n=pn(t,e);try{return await cn(t,n)}catch(i){throw $o(i)?new Error(`Checkpoint ${e} not found`):i}}else return await Mo(t,e)}async function Xt(t,e,n){if(e==="latest"){let i=await nt(t,{tag:n});if(!i)throw new Error("No checkpoints found");return i.id}return e}async function hn(t,e){if(t.mode==="byok")return an(t,ln(t,e.hash),"get");{let n=await un(t,e.tag,e.hash,"get");if(!n.url)throw new Error("Gateway presign returned no download URL");return n.url}}function yn(t){return !(!t||isAbsolute(t)||t.startsWith("-")||normalize(t).startsWith("..")||t.includes("\0"))}function en(t,e){let n=resolve(t,e),i=resolve(t),c=relative(i,n);if(c.startsWith("..")||isAbsolute(c))throw new Error(`Path traversal detected: "${e}" resolves outside target directory`)}function $o(t){let e=t.name,n=t.message;return t?.$metadata?.httpStatusCode===404||e==="NoSuchKey"||e==="NotFound"||n==="NoSuchKey"}function Ze(t){let e=t.filter(n=>!yn(n));if(e.length>0)throw new Error(`Archive contains unsafe path(s): ${e.slice(0,3).join(", ")}`);return t}var wn=10*1024*1024,tn=false;async function vn(){if(!tn)try{await et("tar",["--version"]),tn=!0;}catch{throw new Error("The 'tar' command is not available on this system. Storage download/extract requires tar (available on macOS, Linux, and Windows with Git Bash or WSL).")}}async function nn(t,e){let n=await ot(t,e),i=await hn(t,n),c=e.replace(/[^a-zA-Z0-9_-]/g,"_"),s=join(tmpdir(),`evolve-dl-${c}-${Date.now()}.tar.gz`),a=await fetch(i);if(!a.ok)throw new Error(`Checkpoint download failed (${a.status})`);if(!a.body)throw new Error("Checkpoint download returned empty body");let p=createHash("sha256"),r=createWriteStream(s);try{let o=a.body.getReader();await new Promise((u,d)=>{r.on("error",d),r.on("finish",u);async function m(){for(;;){let{done:f,value:g}=await o.read();if(f){r.end();break}p.update(g),r.write(g)||await new Promise(h=>r.once("drain",h));}}m().catch(d);});}catch(o){throw r.destroy(),await unlink(s).catch(()=>{}),o}let l=p.digest("hex");if(l!==n.hash)throw await unlink(s).catch(()=>{}),new Error(`Checkpoint integrity check failed (expected ${n.hash}, got ${l})`);return {tmpPath:s,metadata:n}}async function on(t){await vn();let{stdout:e}=await et("tar",["-tvzf",t],{maxBuffer:wn}),n=new Set,i=[],c=[];for(let s of e.trim().split(`
`)){if(!s||s.startsWith("total "))continue;let a=s[0];if(a!=="-"&&a!=="d"&&a!=="l")throw new Error(`Archive contains unsupported entry type: "${a}"`);let p=s.match(/\d{2}:\d{2}\s+(.+)/)??s.match(/[A-Z][a-z]{2}\s+\d{1,2}\s+\d{4}\s+(.+)/);if(!p)continue;let r=p[1];if(a==="l"){let l=r.indexOf(" -> ");l!==-1&&(r=r.slice(0,l)),n.add(r);}else a==="d"?i.push(r.replace(/\/$/,"")):c.push(r);}return Ze(i),Ze([...n]),Ze(c)}async function Qe(t,e,n){await vn(),await mkdir(e,{recursive:true});let i=["-xzf",t,"--no-same-owner","--no-same-permissions","-C",e];n?.length&&i.push("--",...n),await et("tar",i,{maxBuffer:wn});}function Do(t){let e="^",n=0;for(;n<t.length;){let i=t[n];i==="*"&&t[n+1]==="*"?t[n+2]==="/"?(e+="(?:.*/)?",n+=3):(e+=".*",n+=2):i==="*"?(e+="[^/]*",n++):i==="?"?(e+="[^/]",n++):".+^${}()|[]\\".includes(i)?(e+="\\"+i,n++):(e+=i,n++);}return e+="$",new RegExp(e)}function it(t,e){let n=mn(t,e);return xn(n)}function Uo(t){let e=mn(t||{});return xn(e)}function xn(t){return {async listCheckpoints(e){let n=Ao(e?.limit);return t.mode==="byok"?fn(t,{limit:n,tag:e?.tag}):gn(t,{limit:n,tag:e?.tag})},async getCheckpoint(e){return ot(t,e)},async downloadCheckpoint(e,n){let i=n?.extract!==false,c=n?.to||process.cwd(),s=await Xt(t,e),{tmpPath:a,metadata:p}=await nn(t,s);try{if(i)return await mkdir(c,{recursive:!0}),await on(a),await Qe(a,c),c;{await mkdir(c,{recursive:!0});let r=join(c,`checkpoint-${p.id}.tar.gz`);return await copyFile(a,r),r}}finally{await unlink(a).catch(()=>{});}},async downloadFiles(e,n){let i=await Xt(t,e),{tmpPath:c}=await nn(t,i),s;try{let a=await on(c),p;if(n?.files){let l=n.files.filter(u=>!yn(u));if(l.length>0)throw new Error(`Unsafe file path requested: ${l[0]}`);let o=new Set(n.files);p=a.filter(u=>o.has(u));}else if(n?.glob){let l=n.glob.map(Do);p=a.filter(o=>l.some(u=>u.test(o)));}else p=a;if(p.length===0)return {};s=join(tmpdir(),`evolve-extract-${Date.now()}`);try{await Qe(c,s,p);}catch(l){let o=l?.message??"";if(!o.includes("E2BIG")&&!o.includes("Argument list too long")&&!o.includes("ENAMETOOLONG"))throw l;await rm(s,{recursive:!0,force:!0}).catch(()=>{}),s=join(tmpdir(),`evolve-extract-${Date.now()}`),await Qe(c,s);}let r={};return await Promise.all(p.map(async l=>{en(s,l),r[l]=await readFile(join(s,l));})),n?.to&&(await mkdir(n.to,{recursive:!0}),await Promise.all(Object.entries(r).map(async([l,o])=>{en(n.to,l);let u=join(n.to,l);await mkdir(dirname(u),{recursive:!0}),await writeFile(u,o);}))),r}finally{s&&await rm(s,{recursive:true,force:true}).catch(()=>{}),await unlink(c).catch(()=>{});}}}}function Lo(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\$/g,"\\$").replace(/`/g,"\\`")}var Q=class{agentConfig;options;sandbox;hasRun=false;workingDir;lastRunTimestamp;registry;sessionLogger;activeCommand;activeProcessId=null;activeOperationId=null;activeOperationKind=null;nextOperationId=0;interruptedOperations=new Set;sandboxState;agentState="idle";skills;storage;lastCheckpointId;zodSchema;jsonSchema;schemaOptions;compiledValidator;constructor(e,n={}){if(this.agentConfig=e,this.options=n,this.workingDir=n.workingDirectory||yt,this.sandboxState=n.sandboxId?"ready":"stopped",this.skills=n.skills,this.storage=n.storage,n.schema)if(R(n.schema))this.zodSchema=n.schema,n.schemaOptions&&console.warn("[Evolve] schemaOptions ignored for Zod schemas - use .passthrough(), .strip(), z.coerce instead");else {this.jsonSchema=n.schema,this.schemaOptions=n.schemaOptions;try{let i=this.createAjvValidator();this.compiledValidator=i.compile(this.jsonSchema);}catch(i){throw new Error(`Invalid JSON Schema: ${i.message}`)}}this.registry=O(e.type);}emitLifecycle(e,n){e?.onLifecycle?.({sandboxId:this.getSession(),sandbox:this.sandboxState,agent:this.agentState,timestamp:new Date().toISOString(),reason:n});}invalidateActiveOperation(){this.activeCommand=void 0,this.activeProcessId=null,this.activeOperationId=null,this.activeOperationKind=null;}beginOperation(e,n,i,c){let s=++this.nextOperationId;return this.activeOperationId=s,this.activeOperationKind=e,this.activeCommand=n,this.activeProcessId=n.processId,this.sandboxState="running",this.agentState="running",this.emitLifecycle(i,c),s}finalizeOperation(e,n,i,c="idle",s="ready"){return this.activeOperationId!==e?false:(this.invalidateActiveOperation(),this.sandboxState=s,this.agentState=c,this.emitLifecycle(n,i),true)}watchBackgroundOperation(e,n,i,c){let s=n==="run"?"run_background_complete":"command_background_complete",a=n==="run"?"run_background_failed":"command_background_failed",p=n==="run"?"run_interrupted":"command_interrupted";i.wait().then(r=>{if(this.interruptedOperations.delete(e)||r.exitCode===130){this.finalizeOperation(e,c,p,"interrupted");return}let o=r.exitCode===0?s:a,u=r.exitCode===0?"idle":"error";this.finalizeOperation(e,c,o,u);}).catch(()=>{this.interruptedOperations.delete(e),this.finalizeOperation(e,c,a,"error");});}createAjvValidator(){let n={...Te[this.schemaOptions?.mode||"loose"],...this.schemaOptions?.coerceTypes!==void 0&&{coerceTypes:this.schemaOptions.coerceTypes},...this.schemaOptions?.removeAdditional!==void 0&&{removeAdditional:this.schemaOptions.removeAdditional},...this.schemaOptions?.useDefaults!==void 0&&{useDefaults:this.schemaOptions.useDefaults},...this.schemaOptions?.allErrors!==void 0&&{allErrors:this.schemaOptions.allErrors}};return new Fo({...n,strict:false})}async getSandbox(e){if(this.sandbox)return this.sandbox;if(!this.options.sandboxProvider)throw new Error("No sandbox provider configured");let n=this.options.sandboxProvider;this.sandboxState="booting",this.emitLifecycle(e,"sandbox_boot");try{if(this.options.sandboxId)(this.options.mcpServers||this.options.context||this.options.files||this.options.systemPrompt)&&console.warn("[Evolve] Connecting to existing sandbox - ignoring mcpServers, context, files, and systemPrompt"),this.sandbox=await n.connect(this.options.sandboxId),this.hasRun=!0,this.sandboxState="ready",this.agentState="idle",this.emitLifecycle(e,"sandbox_connected");else {let i=this.buildEnvironmentVariables();this.sandbox=await n.create({envs:i,workingDirectory:this.workingDir}),await this.setupAgentAuth(this.sandbox),await this.setupWorkspace(this.sandbox),this.sandboxState="ready",this.agentState="idle",this.emitLifecycle(e,"sandbox_ready");}}catch(i){throw this.sandboxState="error",this.agentState="error",this.emitLifecycle(e,"sandbox_error"),i}return this.sandbox}buildEnvironmentVariables(){let e={};if(this.agentConfig.oauthFileContent)this.registry.oauthActivationEnv&&(e[this.registry.oauthActivationEnv.key]=this.registry.oauthActivationEnv.value);else if(this.registry.providerEnvMap&&!this.agentConfig.isDirectMode)for(let n of Object.values(this.registry.providerEnvMap))e[n.keyEnv]=this.agentConfig.apiKey;else {let n=this.agentConfig.model?.split("/")[0],i=n?this.registry.providerEnvMap?.[n]:void 0,c=i?i.keyEnv:this.registry.apiKeyEnv,s=this.agentConfig.isOAuth&&this.registry.oauthEnv?this.registry.oauthEnv:c;e[s]=this.agentConfig.apiKey;}if(this.agentConfig.isDirectMode&&!this.agentConfig.isOAuth)this.agentConfig.baseUrl&&(e[this.registry.baseUrlEnv]=this.agentConfig.baseUrl);else if(!this.agentConfig.isDirectMode){let n=this.registry.usePassthroughGateway?dt():J();if(this.registry.gatewayConfigEnv){let i=this.agentConfig.model||this.registry.defaultModel;e[this.registry.gatewayConfigEnv]=JSON.stringify({provider:{litellm:{npm:"@ai-sdk/openai-compatible",options:{baseURL:`${n}/v1`,apiKey:this.agentConfig.apiKey},models:{[i]:{name:i}}}}});}else e[this.registry.baseUrlEnv]=n;e.EVOLVE_API_KEY=this.agentConfig.apiKey;}return this.options.secrets&&Object.assign(e,this.options.secrets),e}async setupAgentAuth(e){if(this.agentConfig.oauthFileContent&&this.registry.oauthFileName){let n=this.registry.mcpConfig.settingsDir.replace(/^~/,"/home/user");await e.files.makeDir(n),await e.files.write(`${n}/${this.registry.oauthFileName}`,this.agentConfig.oauthFileContent);return}this.registry.setupCommand&&await e.commands.run(this.registry.setupCommand,{timeoutMs:3e4});}async setupWorkspace(e,n){let i=this.options.workspaceMode||"knowledge",c=i==="swe"?`${this.workingDir}/repo ${this.workingDir}/context ${this.workingDir}/scripts ${this.workingDir}/temp ${this.workingDir}/output`:`${this.workingDir}/context ${this.workingDir}/scripts ${this.workingDir}/temp ${this.workingDir}/output`;if(await e.commands.run(`mkdir -p ${c}`,{timeoutMs:3e4}),!n?.skipSystemPrompt){let a=Je({workingDir:this.workingDir,systemPrompt:this.options.systemPrompt,schema:this.zodSchema||this.jsonSchema,mode:i}),p=`${this.workingDir}/${this.registry.systemPromptFile}`;await e.files.write(p,a);}this.options.context&&await this.uploadContextFiles(e,this.options.context),this.options.files&&await this.uploadWorkspaceFiles(e,this.options.files);let s={...this.options.mcpServers};if(this.options.composio){let a=await Ye(this.options.composio.userId,this.options.composio.config);s={...s,composio:{type:"http",url:a.url,headers:a.headers}};}Object.keys(s).length>0&&await Ae(this.agentConfig.type,e,this.workingDir,s),this.skills?.length&&await this.setupSkills(e);}async setupSkills(e){if(!this.skills?.length)return;let{skillsConfig:n}=this.registry,{sourceDir:i,targetDir:c}=n;await e.files.makeDir(c);for(let s of this.skills){let a=`cp -r ${i}/${s} ${c}/ 2>/dev/null || true`;await e.commands.run(a,{timeoutMs:3e4});}}async uploadContextFiles(e,n){let i=Object.entries(n).map(([s,a])=>({path:`${this.workingDir}/context/${s}`,data:a}));if(i.length===0)return;let c=new Set(i.map(s=>s.path.substring(0,s.path.lastIndexOf("/"))).filter(Boolean));c.size>0&&await e.commands.run(`mkdir -p ${Array.from(c).join(" ")}`,{timeoutMs:3e4}),await e.files.writeBatch(i);}async uploadWorkspaceFiles(e,n){let i=Object.entries(n).map(([s,a])=>({path:s.startsWith("/")?s:`${this.workingDir}/${s}`,data:a}));if(i.length===0)return;let c=new Set(i.map(s=>s.path.substring(0,s.path.lastIndexOf("/"))).filter(Boolean));c.size>0&&await e.commands.run(`mkdir -p ${Array.from(c).join(" ")}`,{timeoutMs:3e4}),await e.files.writeBatch(i);}buildCommand(e){return this.registry.buildCommand({prompt:Lo(e),model:this.agentConfig.model||this.registry.defaultModel,isResume:this.hasRun,reasoningEffort:this.agentConfig.reasoningEffort,isDirectMode:this.agentConfig.isDirectMode,skills:this.skills})}async run(e,n){let{prompt:i,timeoutMs:c=G,background:s=false,checkpointComment:a}=e,{from:p}=e;if(this.activeCommand)throw new Error("Agent is already running. Call interrupt(), wait for the active/background run to finish, or create a new Evolve instance.");if(p&&(this.sandbox||this.options.sandboxId))throw new Error("Cannot restore into existing sandbox. Call kill() first, or create a new Evolve instance.");if(p==="latest"){if(!this.storage)throw new Error('Storage not configured. Call .withStorage() before using from: "latest".');let y=await nt(this.storage);if(!y)throw new Error('No checkpoints found for from: "latest".');p=y.id;}if(p){if(!this.storage)throw new Error("Storage not configured. Call .withStorage() before using 'from'.");if(!this.options.sandboxProvider)throw new Error("No sandbox provider configured");let y=this.buildEnvironmentVariables();this.sandboxState="booting",this.emitLifecycle(n,"sandbox_boot");try{this.sandbox=await this.options.sandboxProvider.create({envs:y,workingDirectory:this.workingDir});let w=await dn(this.sandbox,this.storage,p);if(w.agentType&&w.agentType!==this.agentConfig.type)throw new Error(`Cannot restore checkpoint: agent type mismatch (checkpoint: ${w.agentType}, current: ${this.agentConfig.type})`);let k=this.options.workspaceMode||"knowledge";if(w.workspaceMode&&w.workspaceMode!==k)throw new Error(`Cannot restore checkpoint: workspace mode mismatch (checkpoint: ${w.workspaceMode}, current: ${k})`);await this.setupAgentAuth(this.sandbox);let b=!!(this.options.systemPrompt||this.zodSchema||this.jsonSchema);await this.setupWorkspace(this.sandbox,{skipSystemPrompt:!b}),this.hasRun=!0,this.lastCheckpointId=p,this.sandboxState="ready",this.agentState="idle",this.emitLifecycle(n,"sandbox_ready");}catch(w){throw this.sandbox&&(await this.sandbox.kill().catch(()=>{}),this.sandbox=void 0),this.sandboxState="error",this.agentState="error",this.emitLifecycle(n,"sandbox_error"),w}}let r=await this.getSandbox(n);if(this.lastRunTimestamp=Date.now(),!this.sessionLogger){let y=this.options.sandboxProvider;this.sessionLogger=new H({provider:y?.name||y?.providerType||"unknown",agent:this.agentConfig.type,model:this.agentConfig.model||this.registry.defaultModel,sandboxId:r.sandboxId,tagPrefix:this.options.sessionTagPrefix,apiKey:this.agentConfig.isDirectMode?void 0:this.agentConfig.apiKey,observability:this.options.observability});}this.sessionLogger.writePrompt(i);let l=this.buildCommand(i),o="",u=M(this.agentConfig.type),d=y=>{o+=y;let w=o.split(`
`);o=w.pop()??"";for(let k of w){if(!k.trim())continue;let b=u(k);if(this.sessionLogger?.writeEventParsed(k,b),n?.onStdout?.(k+`
`),b&&n?.onContent)for(let C of b)n.onContent(C);}},m=y=>{n?.onStderr?.(y);},f=await r.commands.spawn(l,{cwd:this.workingDir,timeoutMs:c,onStdout:d,onStderr:m}),g=this.beginOperation("run",f,n,"run_start");if(this.hasRun=true,s)return this.watchBackgroundOperation(g,"run",f,n),{sandboxId:r.sandboxId,exitCode:0,stdout:`Background process started with ID ${f.processId}`,stderr:""};let h;try{h=await f.wait();}catch(y){throw this.interruptedOperations.delete(g),this.finalizeOperation(g,n,"run_failed","error"),y}if(this.interruptedOperations.delete(g)||h.exitCode===130?this.finalizeOperation(g,n,"run_interrupted","interrupted"):h.exitCode===0?this.finalizeOperation(g,n,"run_complete","idle"):this.finalizeOperation(g,n,"run_failed","error"),o.trim()){let y=u(o);if(this.sessionLogger?.writeEventParsed(o,y),n?.onStdout?.(o+`
`),y&&n?.onContent)for(let w of y)n.onContent(w);}this.sessionLogger&&!s&&await Promise.race([this.sessionLogger.flush(),new Promise(y=>setTimeout(y,2e3))]);let x;if(this.storage&&!s&&h.exitCode===0)try{x=await tt(r,this.storage,this.agentConfig.type,this.workingDir,{tag:this.sessionLogger?.getTag()||"unknown",model:this.agentConfig.model||this.registry.defaultModel,workspaceMode:this.options.workspaceMode||"knowledge",comment:a,parentId:this.lastCheckpointId}),this.lastCheckpointId=x.id;}catch(y){console.warn(`[Evolve] Auto-checkpoint failed: ${y.message}`);}return {sandboxId:r.sandboxId,exitCode:h.exitCode,stdout:h.stdout,stderr:h.stderr,checkpoint:x}}async executeCommand(e,n={},i){let{timeoutMs:c=G,background:s=false}=n;if(this.activeCommand)throw new Error("Agent is already running. Call interrupt(), wait for the active/background command to finish, or create a new Evolve instance.");let a=await this.getSandbox(i);this.lastRunTimestamp=Date.now();let p="",r="",l=g=>{p+=g,i?.onStdout?.(g);},o=g=>{r+=g,i?.onStderr?.(g);},u=await a.commands.spawn(e,{cwd:this.workingDir,timeoutMs:c,onStdout:l,onStderr:o}),d=this.beginOperation("command",u,i,"command_start");if(s)return this.watchBackgroundOperation(d,"command",u,i),{sandboxId:a.sandboxId,exitCode:0,stdout:`Background process started with ID ${u.processId}`,stderr:""};let m;try{m=await u.wait();}catch(g){throw this.interruptedOperations.delete(d),this.finalizeOperation(d,i,"command_failed","error"),g}return this.interruptedOperations.delete(d)||m.exitCode===130?this.finalizeOperation(d,i,"command_interrupted","interrupted"):m.exitCode===0?this.finalizeOperation(d,i,"command_complete","idle"):this.finalizeOperation(d,i,"command_failed","error"),{sandboxId:a.sandboxId,exitCode:m.exitCode,stdout:p||m.stdout||"",stderr:r||m.stderr||""}}async uploadContext(e){let n=await this.getSandbox();await this.uploadContextFiles(n,e);}async uploadFiles(e){let n=await this.getSandbox();await this.uploadWorkspaceFiles(n,e);}async getOutputFiles(e=false){let n=await this.getSandbox(),i=`${this.workingDir}/output`,c=e?"":"-maxdepth 1",a=(await n.commands.run(`find ${i} ${c} -type f -exec stat -c '%n|%Z' {} \\; 2>/dev/null || true`,{timeoutMs:3e4})).stdout.split(`
`).filter(Boolean),p=this.lastRunTimestamp?Math.floor(this.lastRunTimestamp/1e3)-2:0,r=[],l=`${i}/`;for(let f of a){let[g,h]=f.split("|");if(!g||!h)continue;let v=parseInt(h,10);p>0&&v<p||r.push(g);}let o={},u=await Promise.all(r.map(async f=>{try{let g=await n.files.read(f);return {relativePath:f.startsWith(l)?f.slice(l.length):f.split("/").pop()||f,content:g}}catch{return null}}));for(let f of u)f&&(o[f.relativePath]=f.content);if(!this.zodSchema&&!this.jsonSchema)return {files:o,data:null};let d=o["result.json"];if(!d)return {files:o,data:null,error:"Schema provided but agent did not create output/result.json"};let m=typeof d=="string"?d:new TextDecoder().decode(d);try{let f=JSON.parse(m);if(this.zodSchema){let g=this.zodSchema.safeParse(f);return g.success?{files:o,data:g.data}:{files:o,data:null,error:`Schema validation failed: ${g.error.message}`,rawData:m}}if(this.compiledValidator){if(this.compiledValidator(f))return {files:o,data:f};{let h=this.compiledValidator.errors?.map(v=>`${v.instancePath} ${v.message}`).join(", ")||"Unknown validation error";return {files:o,data:null,error:`Schema validation failed: ${h}`,rawData:m}}}return {files:o,data:null}}catch(f){return {files:o,data:null,error:`Failed to parse result.json: ${f.message}`,rawData:m}}}async checkpoint(e){if(!this.storage)throw new Error("Storage not configured. Call .withStorage().");if(!this.sandbox)throw new Error("No active sandbox. Call run() first.");let n=await tt(this.sandbox,this.storage,this.agentConfig.type,this.workingDir,{tag:this.sessionLogger?.getTag()||"unknown",model:this.agentConfig.model||this.registry.defaultModel,workspaceMode:this.options.workspaceMode||"knowledge",comment:e?.comment,parentId:this.lastCheckpointId});return this.lastCheckpointId=n.id,n}getSession(){return this.sandbox?.sandboxId||this.options.sandboxId||null}async setSession(e){if(this.activeCommand&&!await this.interrupt())throw new Error("Cannot switch session while an active process is running and could not be interrupted.");this.sessionLogger&&(await this.sessionLogger.close(),this.sessionLogger=void 0),this.options.sandboxId=e,this.sandbox=void 0,this.interruptedOperations.clear(),this.invalidateActiveOperation(),this.sandboxState="ready",this.agentState="idle",this.hasRun=true,this.lastCheckpointId=void 0;}async pause(e){this.sandbox&&(this.activeCommand&&await this.interrupt(e),await this.sandbox.pause(),this.sandboxState="paused",this.agentState="idle",this.emitLifecycle(e,"sandbox_pause"));}async resume(e){this.sandbox&&this.options.sandboxProvider&&(this.sandbox=await this.options.sandboxProvider.connect(this.sandbox.sandboxId),this.sandboxState="ready",this.agentState="idle",this.emitLifecycle(e,"sandbox_resume"));}async interrupt(e){if(!this.activeCommand&&!this.activeProcessId)return  false;let n=this.activeOperationId,i=this.activeOperationKind,c=false;try{this.activeCommand?c=await this.activeCommand.kill():this.sandbox&&this.activeProcessId&&(c=await this.sandbox.commands.kill(this.activeProcessId));}catch{c=false;}if(!c)return this.sandboxState="running",this.agentState="running",false;n!==null&&this.interruptedOperations.add(n),this.invalidateActiveOperation(),this.sandboxState="ready",this.agentState="interrupted";let s=i==="run"?"run_interrupted":"command_interrupted";return this.emitLifecycle(e,s),c}status(){return {sandboxId:this.getSession(),sandbox:this.sandboxState,agent:this.agentState,activeProcessId:this.activeProcessId,hasRun:this.hasRun,timestamp:new Date().toISOString()}}async kill(e){this.sessionLogger&&(await this.sessionLogger.close(),this.sessionLogger=void 0),this.activeCommand&&await this.interrupt(e),this.sandbox&&(await this.sandbox.kill(),this.sandbox=void 0),this.options.sandboxId=void 0,this.interruptedOperations.clear(),this.invalidateActiveOperation(),this.sandboxState="stopped",this.agentState="idle",this.hasRun=false,this.lastCheckpointId=void 0,this.emitLifecycle(e,"sandbox_killed");}async getHost(e){return (await this.getSandbox()).getHost(e)}getAgentType(){return this.agentConfig.type}getSessionTag(){return this.sessionLogger?.getTag()||null}getSessionTimestamp(){return this.sessionLogger?.getTimestamp()||null}async flushObservability(){await this.sessionLogger?.flush();}};var X=class extends EventEmitter{config={};agent;fallbackSandboxState="stopped";fallbackAgentState="idle";fallbackHasRun=false;constructor(){super();}on(e,n){return super.on(e,n)}off(e,n){return super.off(e,n)}emit(e,...n){return super.emit(e,...n)}withAgent(e){return e&&(this.config.agent=e,this._cachedGatewayOverrides=null),this}withSandbox(e){return this.config.sandbox=e,this}withWorkingDirectory(e){return this.config.workingDirectory=e,this}withWorkspaceMode(e){return this.config.workspaceMode=e,this}withSecrets(e){return this.config.secrets={...this.config.secrets,...e},this}withSession(e){return this.config.sandboxId=e,this.agent||(this.fallbackSandboxState="ready",this.fallbackAgentState="idle",this.fallbackHasRun=true),this}withSystemPrompt(e){return this.config.systemPrompt=e,this}withContext(e){return this.config.context={...this.config.context,...e},this}withFiles(e){return this.config.files={...this.config.files,...e},this}withMcpServers(e){return this.config.mcpServers={...this.config.mcpServers,...e},this}withSkills(e){return this.config.skills=e,this}withSchema(e,n){return this.config.schema=e,n&&(R(e)?console.warn("[Evolve] schemaOptions ignored for Zod schemas - use .passthrough(), .strip(), z.coerce instead"):this.config.schemaOptions=n),this}withSessionTagPrefix(e){return this.config.sessionTagPrefix=e,this}withObservability(e){return this.config.observability={...this.config.observability,...e},this}withComposio(e,n){return this.config.composio={userId:e,config:n},this}withStorage(e){return this.config.storage=e||{},this}static composio=qe;async initializeAgent(){let e=ye(this.config.agent),n=this.config.sandbox??await je(),i=e.isDirectMode?{}:ft(e.apiKey),c=this.config.storage!==void 0?Ce(this.config.storage,!e.isDirectMode,E,e.isDirectMode?void 0:e.apiKey):void 0,s={sandboxProvider:n,secrets:this.config.secrets,sandboxId:this.config.sandboxId,workingDirectory:this.config.workingDirectory,workspaceMode:this.config.workspaceMode,systemPrompt:this.config.systemPrompt,context:this.config.context,files:this.config.files,mcpServers:{...i,...this.config.mcpServers},skills:this.config.skills,schema:this.config.schema,schemaOptions:this.config.schemaOptions,sessionTagPrefix:this.config.sessionTagPrefix,observability:this.config.observability,composio:this.config.composio,storage:c};this.agent=new Q(e,s);}createStreamCallbacks(){let e=this.listenerCount("stdout")>0,n=this.listenerCount("stderr")>0,i=this.listenerCount("content")>0,c=this.listenerCount("lifecycle")>0;return {onStdout:e?s=>this.emit("stdout",s):void 0,onStderr:n?s=>this.emit("stderr",s):void 0,onContent:i?s=>this.emit("content",s):void 0,onLifecycle:c?s=>this.emit("lifecycle",s):void 0}}emitLifecycleFromStatus(e){if(this.listenerCount("lifecycle")===0)return;let n=this.status();this.emit("lifecycle",{sandboxId:n.sandboxId,sandbox:n.sandbox,agent:n.agent,timestamp:new Date().toISOString(),reason:e});}async run({prompt:e,timeoutMs:n,background:i,from:c,checkpointComment:s}){if(c&&this.config.sandboxId)throw new Error("Cannot use 'from' with 'withSession()' \u2014 restore requires a fresh sandbox.");this.agent||await this.initializeAgent();let a=this.createStreamCallbacks();return this.agent.run({prompt:e,timeoutMs:n,background:i,from:c,checkpointComment:s},a)}async executeCommand(e,n={}){this.agent||await this.initializeAgent();let i=this.createStreamCallbacks();return this.agent.executeCommand(e,n,i)}async interrupt(){if(!this.agent)return  false;let e=this.createStreamCallbacks();return this.agent.interrupt(e)}async uploadContext(e){return this.agent||await this.initializeAgent(),this.agent.uploadContext(e)}async uploadFiles(e){return this.agent||await this.initializeAgent(),this.agent.uploadFiles(e)}async getOutputFiles(e=false){if(!this.agent)throw new Error("Agent not initialized. Call run() first.");return this.agent.getOutputFiles(e)}async checkpoint(e){if(!this.agent)throw new Error("Agent not initialized. Call run() first.");return this.agent.checkpoint(e)}_cachedGatewayOverrides=null;resolveGatewayOverrides(){if(this._cachedGatewayOverrides!==null)return this._cachedGatewayOverrides||void 0;try{let e=ye(this.config.agent);if(!e.isDirectMode)return this._cachedGatewayOverrides={gatewayUrl:E,gatewayApiKey:e.apiKey},this._cachedGatewayOverrides}catch{}this._cachedGatewayOverrides=void 0;}async listCheckpoints(e){if(this.config.storage===void 0)throw new Error("Storage not configured. Call .withStorage().");return it(this.config.storage,this.resolveGatewayOverrides()||{}).listCheckpoints(e)}storage(){if(this.config.storage===void 0)throw new Error("Storage not configured. Call .withStorage().");return it(this.config.storage,this.resolveGatewayOverrides()||{})}getSession(){return this.agent?this.agent.getSession():this.config.sandboxId??null}async setSession(e){this.agent?await this.agent.setSession(e):(this.fallbackSandboxState="ready",this.fallbackAgentState="idle",this.fallbackHasRun=true),this.config.sandboxId=e;}status(){return this.agent?this.agent.status():{sandboxId:this.config.sandboxId??null,sandbox:this.fallbackSandboxState,agent:this.fallbackAgentState,activeProcessId:null,hasRun:this.fallbackHasRun,timestamp:new Date().toISOString()}}async pause(){if(this.agent){let e=this.createStreamCallbacks();await this.agent.pause(e);return}this.config.sandboxId&&this.config.sandbox&&(await(await this.config.sandbox.connect(this.config.sandboxId)).pause(),this.fallbackSandboxState="paused",this.fallbackAgentState="idle",this.emitLifecycleFromStatus("sandbox_pause"));}async resume(){if(this.agent){let e=this.createStreamCallbacks();await this.agent.resume(e);return}this.config.sandboxId&&this.config.sandbox&&(await this.config.sandbox.connect(this.config.sandboxId),this.fallbackSandboxState="ready",this.fallbackAgentState="idle",this.emitLifecycleFromStatus("sandbox_resume"));}async kill(){if(this.agent){let e=this.createStreamCallbacks();await this.agent.kill(e),this.config.sandboxId=void 0,this.fallbackSandboxState="stopped",this.fallbackAgentState="idle",this.fallbackHasRun=false;return}this.config.sandboxId&&this.config.sandbox&&(await(await this.config.sandbox.connect(this.config.sandboxId)).kill(),this.fallbackSandboxState="stopped",this.fallbackAgentState="idle",this.fallbackHasRun=false,this.emitLifecycleFromStatus("sandbox_killed"),this.config.sandboxId=void 0);}async getHost(e){return this.agent||await this.initializeAgent(),this.agent.getHost(e)}getSessionTag(){return this.agent?.getSessionTag()||null}getSessionTimestamp(){return this.agent?.getSessionTimestamp()||null}async flushObservability(){await this.agent?.flushObservability();}};var W=class{permits;queue=[];constructor(e){if(e<1)throw new Error("Semaphore max must be >= 1");this.permits=e;}async use(e){await this.acquire();try{return await e()}finally{this.release();}}acquire(){return this.permits>0?(this.permits--,Promise.resolve()):new Promise(e=>this.queue.push(e))}release(){this.queue.length>0?this.queue.shift()():this.permits++;}};var $=Symbol.for("evolve.SwarmResult"),z=class t extends Array{get success(){return this.filter(e=>e.status==="success")}get filtered(){return this.filter(e=>e.status==="filtered")}get error(){return this.filter(e=>e.status==="error")}static from(e){let n=new t;return n.push(...e),n}};var st=class t{config;semaphore;constructor(e={}){let n=e.concurrency??ht;if(n>Be)throw new Error(`concurrency=${n} exceeds max ${Be}. For higher parallelism, scale horizontally with multiple processes.`);this.config={agent:e.agent,sandbox:e.sandbox,tag:e.tag??"swarm",concurrency:n,timeoutMs:e.timeoutMs??G,workspaceMode:e.workspaceMode??"knowledge",retry:e.retry,mcpServers:e.mcpServers,skills:e.skills,composio:e.composio},this.semaphore=new W(this.config.concurrency);}async map(e){let{items:n,prompt:i,bestOf:c,verify:s}=e,a=e.retry??this.config.retry,p=this.generateOperationId(),r=e.timeoutMs??this.config.timeoutMs;if(c&&s)throw new Error("map() cannot use both bestOf and verify options simultaneously");let l=await Promise.all(n.map((o,u)=>c?this.executeMapItemWithBestOf(o,i,u,p,e,r,a):s?this.executeMapItemWithVerify(o,i,u,p,e,r,a):a?_(d=>this.executeMapItem(o,i,u,p,e,r,d),a,u):this.executeMapItem(o,i,u,p,e,r)));return z.from(l)}async filter(e){let{items:n,prompt:i,condition:c,verify:s}=e,a=e.retry??this.config.retry,p=this.generateOperationId(),r=e.timeoutMs??this.config.timeoutMs,l=await Promise.all(n.map((u,d)=>s?this.executeFilterItemWithVerify(u,i,d,p,e,r,a):a?_(m=>this.executeFilterItem(u,i,d,p,e,r,m),a,d):this.executeFilterItem(u,i,d,p,e,r))),o=[];for(let u of l)if(u.status==="error")o.push(u);else if(u.data!==null)try{c(u.data)?o.push(u):o.push({...u,status:"filtered"});}catch(d){o.push({...u,status:"error",data:null,error:`Condition function threw: ${d.message}`});}return z.from(o)}async reduce(e){let{items:n,prompt:i,verify:c}=e,s=e.retry??this.config.retry,a=this.generateOperationId(),p=e.timeoutMs??this.config.timeoutMs,r=[],l=[];n.forEach((w,k)=>{r.push(this.getFiles(w)),l.push(this.getIndex(w,k));});let o={};r.forEach((w,k)=>{Object.entries(w).forEach(([b,C])=>{o[`item_${l[k]}/${b}`]=C;});});let u=we(o),d=I(Nt,{fileTree:u}),m=e.systemPrompt?`${d}

${e.systemPrompt}`:d,f=(w,k,b)=>({operationId:a,operation:"reduce",tag:w.tag,sandboxId:w.sandboxId,swarmName:this.config.tag,operationName:e.name,inputCount:n.length,inputIndices:l,errorRetry:k,verifyRetry:b,...this.pipelineContextToMeta(e._pipelineContext)}),g=e.mcpServers??this.config.mcpServers,h=e.skills??this.config.skills,v=e.composio??this.config.composio,x=async(w,k,b,C)=>{let S=await this.semaphore.use(()=>this.execute(o,w,{systemPrompt:m,schema:e.schema,schemaOptions:e.schemaOptions,agent:e.agent,mcpServers:g,skills:h,composio:v,tagPrefix:k,timeoutMs:p,observability:{swarmName:this.config.tag,operationName:e.name,operationId:a,operation:"reduce",role:"worker",errorRetry:b,verifyRetry:C&&C>1?C-1:void 0,...this.pipelineContextToObservability(e._pipelineContext)}})),U=f(S,b,C&&C>1?C-1:void 0);return S.error?{status:"error",data:null,files:S.files,meta:U,error:S.error,rawData:S.rawData}:{status:"success",data:S.data,files:S.files,meta:U}},y=`${this.config.tag}-reduce`;return c?this.runWithVerification((w,k,b)=>x(w,k,void 0,b),{originalPrompt:i,inputFiles:o,verifyConfig:c,timeoutMs:p,systemPrompt:m,schema:e.schema,mcpServers:g,skills:h,composio:v,operationId:a,baseTag:y,retry:s,operation:"reduce",_pipelineContext:e._pipelineContext}):s?_(w=>{let k=w>1?w-1:void 0,b=k?`${y}-er${k}`:y;return x(i,b,k)},s):x(i,y)}async bestOf(e){let{item:n,prompt:i,config:c}=e,s=e.retry??this.config.retry,a=c.n??c.taskAgents?.length;if(a===void 0)throw new Error("bestOf requires n or taskAgents");if(a<2)throw new Error("bestOf requires n >= 2");let p=this.generateOperationId(),r=e.timeoutMs??this.config.timeoutMs,l=this.getFiles(n),o=c.mcpServers??this.config.mcpServers,u=c.judgeMcpServers??c.mcpServers??this.config.mcpServers,d=c.skills??this.config.skills,m=c.judgeSkills??c.skills??this.config.skills,f=c.composio??this.config.composio,g=c.judgeComposio??c.composio??this.config.composio,h=await Promise.all(Array.from({length:a},async(k,b)=>{let C=s?await _(S=>this.executeBestOfCandidate({inputFiles:l,prompt:i,candidateIndex:b,operationId:p,config:c,systemPrompt:e.systemPrompt,schema:e.schema,schemaOptions:e.schemaOptions,mcpServers:o,skills:d,composio:f,timeoutMs:r,attempt:S}),s,b):await this.executeBestOfCandidate({inputFiles:l,prompt:i,candidateIndex:b,operationId:p,config:c,systemPrompt:e.systemPrompt,schema:e.schema,schemaOptions:e.schemaOptions,mcpServers:o,skills:d,composio:f,timeoutMs:r});return c.onCandidateComplete?.(0,b,C.status==="success"?"success":"error"),C})),v=s?await _(k=>this.executeBestOfJudge({inputFiles:l,taskPrompt:i,candidates:h,config:c,timeoutMs:r,operationId:p,systemPrompt:e.systemPrompt,schema:e.schema,schemaOptions:e.schemaOptions,mcpServers:u,skills:m,composio:g,attempt:k}),{...s,retryOn:void 0},0):await this.executeBestOfJudge({inputFiles:l,taskPrompt:i,candidates:h,config:c,timeoutMs:r,operationId:p,systemPrompt:e.systemPrompt,schema:e.schema,schemaOptions:e.schemaOptions,mcpServers:u,skills:m,composio:g}),x=h.findIndex(k=>k.status==="success"),y=v.decision?.winner??(x>=0?x:0);c.onJudgeComplete?.(0,y,v.decision?.reasoning??"Judge failed to provide reasoning");let w={operationId:p,operation:"bestof-judge",tag:v.tag,sandboxId:v.sandboxId,swarmName:this.config.tag,operationName:e.name,candidateCount:a};return {winner:h[y]??h[0],winnerIndex:y,judgeReasoning:v.decision?.reasoning??"Judge failed to provide reasoning",judgeMeta:w,candidates:h}}async execute(e,n,i){let c=null,s="",a=i.tagPrefix,p={},r=null,l,o,u={...this.config.agent,...i.agent};try{c=new X().withAgent(u).withSandbox(this.config.sandbox).withWorkspaceMode(this.config.workspaceMode).withSessionTagPrefix(i.tagPrefix),i.schema&&c.withSchema(i.schema,i.schemaOptions),i.systemPrompt&&c.withSystemPrompt(i.systemPrompt),i.mcpServers&&c.withMcpServers(i.mcpServers),i.skills?.length&&c.withSkills(i.skills),i.composio&&c.withComposio(i.composio.userId,i.composio.config),i.observability&&c.withObservability(i.observability),Object.keys(e).length>0&&c.withContext(e);let d=await c.run({prompt:n,timeoutMs:i.timeoutMs});s=d.sandboxId,a=c.getSessionTag()??i.tagPrefix;let m=null;try{m=await c.getOutputFiles(!0),p=m.files;}catch{}d.exitCode!==0?l=`Agent exited with code ${d.exitCode}`:i.schema?m?(r=m.data,m.error&&(l=m.error),m.rawData&&(o=m.rawData)):l="Failed to read output files from sandbox":r=p;}catch(d){if(l=d.message,c){a=c.getSessionTag()??i.tagPrefix;try{p=(await c.getOutputFiles(!0)).files;}catch{}}}finally{c&&await c.kill().catch(()=>{});}return {files:p,data:r,tag:a,sandboxId:s,error:l,rawData:o}}async executeMapItem(e,n,i,c,s,a,p=1){let r=this.getFiles(e),l=p>1?`${this.config.tag}-map-${i}-er${p-1}`:`${this.config.tag}-map-${i}`,o=this.evaluatePrompt(n,r,i);if(o instanceof Error)return this.buildErrorResult(`Prompt function threw: ${o.message}`,{operationId:c,operation:"map",tag:l,sandboxId:"",itemIndex:i});let u=s.mcpServers??this.config.mcpServers,d=s.skills??this.config.skills,m=s.composio??this.config.composio,f=await this.semaphore.use(()=>this.execute(r,o,{systemPrompt:s.systemPrompt,schema:s.schema,schemaOptions:s.schemaOptions,agent:s.agent,mcpServers:u,skills:d,composio:m,tagPrefix:l,timeoutMs:a,observability:{swarmName:this.config.tag,operationName:s.name,operationId:c,operation:"map",itemIndex:i,role:"worker",errorRetry:p>1?p-1:void 0,...this.pipelineContextToObservability(s._pipelineContext)}})),g={operationId:c,operation:"map",tag:f.tag,sandboxId:f.sandboxId,swarmName:this.config.tag,operationName:s.name,itemIndex:i,errorRetry:p>1?p-1:void 0,...this.pipelineContextToMeta(s._pipelineContext)};return this.buildResult(f,g)}async executeMapItemWithVerify(e,n,i,c,s,a,p){let r=this.getFiles(e),l=`${this.config.tag}-map-${i}`,o=s.verify,u=s.mcpServers??this.config.mcpServers,d=s.skills??this.config.skills,m=s.composio??this.config.composio,f=this.evaluatePrompt(n,r,i);if(f instanceof Error)return this.buildErrorResult(`Prompt function threw: ${f.message}`,{operationId:c,operation:"map",tag:l,sandboxId:"",itemIndex:i});let g=async(h,v,x)=>{let y=await this.semaphore.use(()=>this.execute(r,h,{systemPrompt:s.systemPrompt,schema:s.schema,schemaOptions:s.schemaOptions,agent:s.agent,mcpServers:u,skills:d,composio:m,tagPrefix:v,timeoutMs:a,observability:{swarmName:this.config.tag,operationName:s.name,operationId:c,operation:"map",itemIndex:i,role:"worker",verifyRetry:x&&x>1?x-1:void 0,...this.pipelineContextToObservability(s._pipelineContext)}})),w={operationId:c,operation:"map",tag:y.tag,sandboxId:y.sandboxId,swarmName:this.config.tag,operationName:s.name,itemIndex:i,verifyRetry:x&&x>1?x-1:void 0,...this.pipelineContextToMeta(s._pipelineContext)};return this.buildResult(y,w)};return this.runWithVerification(g,{originalPrompt:f,inputFiles:r,verifyConfig:o,timeoutMs:a,systemPrompt:s.systemPrompt,schema:s.schema,mcpServers:u,skills:d,composio:m,operationId:c,baseTag:l,retry:p,itemIndex:i,operation:"map",_pipelineContext:s._pipelineContext})}async executeMapItemWithBestOf(e,n,i,c,s,a,p){let r=this.getFiles(e),l=`${this.config.tag}-map-${i}`,o=this.evaluatePrompt(n,r,i);if(o instanceof Error)return this.buildErrorResult(`Prompt function threw: ${o.message}`,{operationId:c,operation:"map",tag:l,sandboxId:"",itemIndex:i});let u=s.bestOf,d=u.n??u.taskAgents?.length;if(d===void 0||d<2)return this.buildErrorResult("bestOf requires n >= 2 or taskAgents with at least 2 elements",{operationId:c,operation:"map",tag:l,sandboxId:"",itemIndex:i});let m=s.mcpServers??this.config.mcpServers,f=u.mcpServers??m,g=u.judgeMcpServers??u.mcpServers??m,h=s.skills??this.config.skills,v=u.skills??h,x=u.judgeSkills??u.skills??h,y=s.composio??this.config.composio,w=u.composio??y,k=u.judgeComposio??u.composio??y,b=await Promise.all(Array.from({length:d},async(ee,te)=>{let at=p?await _(bn=>this.executeBestOfCandidate({inputFiles:r,prompt:o,candidateIndex:te,operationId:c,config:u,systemPrompt:s.systemPrompt,schema:s.schema,schemaOptions:s.schemaOptions,mcpServers:f,skills:v,composio:w,timeoutMs:a,parentIndex:i,attempt:bn,_pipelineContext:s._pipelineContext}),p,te):await this.executeBestOfCandidate({inputFiles:r,prompt:o,candidateIndex:te,operationId:c,config:u,systemPrompt:s.systemPrompt,schema:s.schema,schemaOptions:s.schemaOptions,mcpServers:f,skills:v,composio:w,timeoutMs:a,parentIndex:i,_pipelineContext:s._pipelineContext});return u.onCandidateComplete?.(i,te,at.status==="success"?"success":"error"),at})),C=p?await _(ee=>this.executeBestOfJudge({inputFiles:r,taskPrompt:o,candidates:b,config:u,timeoutMs:a,operationId:c,systemPrompt:s.systemPrompt,schema:s.schema,schemaOptions:s.schemaOptions,mcpServers:g,skills:x,composio:k,parentIndex:i,attempt:ee,_pipelineContext:s._pipelineContext}),{...p,retryOn:void 0},0):await this.executeBestOfJudge({inputFiles:r,taskPrompt:o,candidates:b,config:u,timeoutMs:a,operationId:c,systemPrompt:s.systemPrompt,schema:s.schema,schemaOptions:s.schemaOptions,mcpServers:g,skills:x,composio:k,parentIndex:i,_pipelineContext:s._pipelineContext}),S=b.findIndex(ee=>ee.status==="success"),U=C.decision?.winner??(S>=0?S:0),rt=b[U]??b[0];u.onJudgeComplete?.(i,U,C.decision?.reasoning??"Judge failed to provide reasoning");let kn={operationId:c,operation:"bestof-judge",tag:C.tag,sandboxId:C.sandboxId,swarmName:this.config.tag,operationName:s.name,candidateCount:d,...this.pipelineContextToMeta(s._pipelineContext)};return {...rt,meta:{...rt.meta,operation:"map",swarmName:this.config.tag,operationName:s.name,itemIndex:i,...this.pipelineContextToMeta(s._pipelineContext)},bestOf:{winnerIndex:U,judgeReasoning:C.decision?.reasoning??"Judge failed to provide reasoning",judgeMeta:kn,candidates:b}}}async executeFilterItem(e,n,i,c,s,a,p=1){let r=this.getFiles(e),l=p>1?`${this.config.tag}-filter-${i}-er${p-1}`:`${this.config.tag}-filter-${i}`,o=s.mcpServers??this.config.mcpServers,u=s.skills??this.config.skills,d=s.composio??this.config.composio,m=await this.semaphore.use(()=>this.execute(r,n,{systemPrompt:s.systemPrompt,schema:s.schema,schemaOptions:s.schemaOptions,agent:s.agent,mcpServers:o,skills:u,composio:d,tagPrefix:l,timeoutMs:a,observability:{swarmName:this.config.tag,operationName:s.name,operationId:c,operation:"filter",itemIndex:i,role:"worker",errorRetry:p>1?p-1:void 0,...this.pipelineContextToObservability(s._pipelineContext)}})),f={operationId:c,operation:"filter",tag:m.tag,sandboxId:m.sandboxId,swarmName:this.config.tag,operationName:s.name,itemIndex:i,errorRetry:p>1?p-1:void 0,...this.pipelineContextToMeta(s._pipelineContext)};return this.buildResult(m,f,r)}async executeFilterItemWithVerify(e,n,i,c,s,a,p){let r=this.getFiles(e),l=`${this.config.tag}-filter-${i}`,o=s.verify,u=s.mcpServers??this.config.mcpServers,d=s.skills??this.config.skills,m=s.composio??this.config.composio,f=async(g,h,v)=>{let x=await this.semaphore.use(()=>this.execute(r,g,{systemPrompt:s.systemPrompt,schema:s.schema,schemaOptions:s.schemaOptions,agent:s.agent,mcpServers:u,skills:d,composio:m,tagPrefix:h,timeoutMs:a,observability:{swarmName:this.config.tag,operationName:s.name,operationId:c,operation:"filter",itemIndex:i,role:"worker",verifyRetry:v&&v>1?v-1:void 0,...this.pipelineContextToObservability(s._pipelineContext)}})),y={operationId:c,operation:"filter",tag:x.tag,sandboxId:x.sandboxId,swarmName:this.config.tag,operationName:s.name,itemIndex:i,verifyRetry:v&&v>1?v-1:void 0,...this.pipelineContextToMeta(s._pipelineContext)};return this.buildResult(x,y,r)};return this.runWithVerification(f,{originalPrompt:n,inputFiles:r,verifyConfig:o,timeoutMs:a,systemPrompt:s.systemPrompt,schema:s.schema,mcpServers:u,skills:d,composio:m,operationId:c,baseTag:l,retry:p,itemIndex:i,operation:"filter",_pipelineContext:s._pipelineContext})}async executeBestOfCandidate(e){let{inputFiles:n,prompt:i,candidateIndex:c,operationId:s,config:a,timeoutMs:p,parentIndex:r,attempt:l=1,_pipelineContext:o}=e,u=r!==void 0?`${this.config.tag}-map-${r}-bestof-cand-${c}`:`${this.config.tag}-bestof-cand-${c}`,d=l>1?`${u}-er${l-1}`:u,m=await this.semaphore.use(()=>this.execute(n,i,{systemPrompt:e.systemPrompt,schema:e.schema,schemaOptions:e.schemaOptions,agent:a.taskAgents?.[c],mcpServers:e.mcpServers,skills:e.skills,composio:e.composio,tagPrefix:d,timeoutMs:p,observability:{swarmName:this.config.tag,operationId:s,operation:"map",itemIndex:r,role:"candidate",candidateIndex:c,errorRetry:l>1?l-1:void 0,...this.pipelineContextToObservability(o)}})),f={operationId:s,operation:"bestof-cand",tag:m.tag,sandboxId:m.sandboxId,swarmName:this.config.tag,itemIndex:c,errorRetry:l>1?l-1:void 0,candidateIndex:c,...this.pipelineContextToMeta(o)};return this.buildResult(m,f)}buildJudgeContext(e){let n=this.buildEvaluatorContext({inputFiles:e.inputFiles,taskPrompt:e.taskPrompt,systemPrompt:e.systemPrompt,schema:e.schema});return e.candidates.forEach((i,c)=>{i.status==="error"&&(n[`candidate_${c}/_failed.txt`]=`STATUS: FAILED

Error: ${i.error??"Unknown error"}`),Object.entries(i.files).forEach(([s,a])=>{n[`candidate_${c}/${s}`]=a;});}),n}async executeBestOfJudge(e){let{candidates:n,config:i,timeoutMs:c,operationId:s,parentIndex:a,attempt:p=1,_pipelineContext:r}=e,l=a!==void 0?`${this.config.tag}-map-${a}-bestof-judge`:`${this.config.tag}-bestof-judge`,o=p>1?`${l}-er${p-1}`:l,u=this.buildJudgeContext({inputFiles:e.inputFiles,taskPrompt:e.taskPrompt,candidates:n,systemPrompt:e.systemPrompt,schema:e.schema}),d=we(u),m=I(Ve,{candidateCount:String(n.length),criteria:i.judgeCriteria,fileTree:d}),f=z$1.object({winner:z$1.number().min(0).max(n.length-1),reasoning:z$1.string()}),g=await this.semaphore.use(()=>this.execute(u,Ft,{systemPrompt:m,schema:f,agent:i.judgeAgent,mcpServers:e.mcpServers,skills:e.skills,composio:e.composio,tagPrefix:o,timeoutMs:c,observability:{swarmName:this.config.tag,operationId:s,operation:"map",itemIndex:a,role:"judge",errorRetry:p>1?p-1:void 0,...this.pipelineContextToObservability(r)}})),h=null;if(g.data&&!g.error)h=g.data;else if(g.rawData)try{let v=JSON.parse(g.rawData);console.warn(`Judge returned invalid winner ${v.winner}, defaulting to candidate 0`),h={winner:0,reasoning:v.reasoning??"Judge failed to provide reasoning"};}catch{console.warn(`Judge validation failed: ${g.error}`);}return {status:h?"success":"error",decision:h,tag:g.tag,sandboxId:g.sandboxId,error:h?void 0:"Judge failed to produce valid decision"}}static DEFAULT_VERIFY_MAX_ATTEMPTS=3;static VerifyDecisionSchema=z$1.object({passed:z$1.boolean(),reasoning:z$1.string(),feedback:z$1.string().optional()});buildVerifyContext(e){let n=this.buildEvaluatorContext({inputFiles:e.inputFiles,taskPrompt:e.taskPrompt,systemPrompt:e.systemPrompt,schema:e.schema});return Object.entries(e.outputFiles).forEach(([i,c])=>{n[`worker_output/${i}`]=c;}),n}async executeVerify(e){let{config:n,timeoutMs:i,operationId:c,workerTag:s,retryAttempt:a=1,operation:p,itemIndex:r,attemptIndex:l,_pipelineContext:o}=e,u=a>1?`${s}-verifier-er${a-1}`:`${s}-verifier`,d=n.verifierMcpServers??e.mcpServers,m=n.verifierSkills??e.skills,f=n.verifierComposio??e.composio,g=this.buildVerifyContext({inputFiles:e.inputFiles,taskPrompt:e.taskPrompt,outputFiles:e.outputFiles,systemPrompt:e.systemPrompt,schema:e.schema}),h=we(g),v=I(We,{criteria:n.criteria,fileTree:h}),x=await this.semaphore.use(()=>this.execute(g,Lt,{systemPrompt:v,schema:t.VerifyDecisionSchema,agent:n.verifierAgent,mcpServers:d,skills:m,composio:f,tagPrefix:u,timeoutMs:i,observability:{swarmName:this.config.tag,operationId:c,operation:p,itemIndex:r,role:"verifier",verifyRetry:l&&l>1?l-1:void 0,errorRetry:a>1?a-1:void 0,...this.pipelineContextToObservability(o)}})),y=null;if(x.data&&!x.error)y=x.data;else if(x.rawData)try{let w=JSON.parse(x.rawData);y={passed:!!w.passed,reasoning:w.reasoning??"Verification completed",feedback:w.feedback};}catch{console.warn(`Verify validation failed: ${x.error}`);}return {status:y?"success":"error",decision:y,tag:x.tag,sandboxId:x.sandboxId,error:y?void 0:"Verifier failed to produce valid decision"}}static buildRetryPromptWithFeedback(e,n){return I(ze,{originalPrompt:e,feedback:n})}async runWithVerification(e,n){let{originalPrompt:i,inputFiles:c,verifyConfig:s,timeoutMs:a,operationId:p,baseTag:r,retry:l,itemIndex:o=0,operation:u,_pipelineContext:d}=n,m=s.maxAttempts??t.DEFAULT_VERIFY_MAX_ATTEMPTS,f=i,g=null,h=0;for(;h<m;){h++;let x=h>1?`${r}-vr${h-1}`:r,y=l?await _(b=>e(f,b>1?`${x}-er${b-1}`:x,h),l,o):await e(f,x,h);if(s.onWorkerComplete?.(o,h,y.status==="error"?"error":"success"),y.status==="error")return y;g=y;let w=l?await _(b=>this.executeVerify({inputFiles:c,outputFiles:y.files,taskPrompt:f,config:s,timeoutMs:a,systemPrompt:n.systemPrompt,schema:n.schema,mcpServers:n.mcpServers,skills:n.skills,composio:n.composio,operationId:p,workerTag:x,retryAttempt:b,operation:u,itemIndex:o,attemptIndex:h,_pipelineContext:d}),{...l,retryOn:void 0}):await this.executeVerify({inputFiles:c,outputFiles:y.files,taskPrompt:f,config:s,timeoutMs:a,systemPrompt:n.systemPrompt,schema:n.schema,mcpServers:n.mcpServers,skills:n.skills,composio:n.composio,operationId:p,workerTag:x,operation:u,itemIndex:o,attemptIndex:h,_pipelineContext:d}),k={operationId:p,operation:"verify",tag:w.tag,sandboxId:w.sandboxId,swarmName:this.config.tag,attempts:h,...this.pipelineContextToMeta(d)};if(s.onVerifierComplete?.(o,h,w.decision?.passed??false,w.decision?.feedback),w.decision?.passed)return {...y,verify:{passed:true,reasoning:w.decision.reasoning,verifyMeta:k,attempts:h}};if(h<m){let b=w.decision?.feedback??w.decision?.reasoning??"Output did not meet criteria";f=t.buildRetryPromptWithFeedback(i,b);}}let v=h>1?`${r}-vr${h-1}`:r;return {...g,status:"error",verify:{passed:false,reasoning:"Max verification retries exceeded",verifyMeta:{operationId:p,operation:"verify",tag:`${v}-verifier`,sandboxId:"",swarmName:this.config.tag,attempts:h,...this.pipelineContextToMeta(d)},attempts:h}}}generateOperationId(){return randomBytes(8).toString("hex")}pipelineContextToObservability(e){return e?{pipelineRunId:e.pipelineRunId,pipelineStepIndex:e.pipelineStepIndex}:{}}pipelineContextToMeta(e){return {pipelineRunId:e?.pipelineRunId,pipelineStepIndex:e?.pipelineStepIndex}}evaluatePrompt(e,n,i){if(typeof e=="string")return e;try{return e(n,i)}catch(c){return c}}buildEvaluatorContext(e){let n={};return e.systemPrompt&&(n["worker_task/system_prompt.txt"]=e.systemPrompt),n["worker_task/user_prompt.txt"]=e.taskPrompt,e.schema&&(n["worker_task/schema.json"]=R(e.schema)?B(e.schema):K(e.schema)),Object.entries(e.inputFiles).forEach(([i,c])=>{n[`worker_task/input/${i}`]=c;}),n}isSwarmResult(e){return typeof e=="object"&&e!==null&&$ in e&&e[$]===true}getFiles(e){if(this.isSwarmResult(e)){let n={...e.files};return n["result.json"]&&(n["data.json"]=n["result.json"],delete n["result.json"]),n}return e}getIndex(e,n){return this.isSwarmResult(e)?e.meta.itemIndex:n}buildResult(e,n,i){let c=i??e.files;return e.error?{[$]:true,status:"error",data:null,files:c,meta:n,error:e.error,rawData:e.rawData}:{[$]:true,status:"success",data:e.data,files:c,meta:n}}buildErrorResult(e,n){return {[$]:true,status:"error",data:null,files:{},meta:n,error:e}}};var Se=class t{swarm;steps;events;constructor(e,n=[],i={}){this.swarm=e,this.steps=n,this.events=i;}map(e){return new t(this.swarm,[...this.steps,{type:"map",config:e}],this.events)}filter(e){return new t(this.swarm,[...this.steps,{type:"filter",config:e}],this.events)}reduce(e){return new _e(this.swarm,[...this.steps,{type:"reduce",config:e}],this.events)}on(e,n){if(typeof e=="string"){let i=`on${e.charAt(0).toUpperCase()}${e.slice(1)}`;return new t(this.swarm,this.steps,{...this.events,[i]:n})}return new t(this.swarm,this.steps,{...this.events,...e})}async run(e){let n=randomBytes(8).toString("hex"),i=[],c=e,s=Date.now();for(let p=0;p<this.steps.length;p++){let r=this.steps[p],l=r.config.name,o=Date.now();this.events.onStepStart?.({type:r.type,index:p,name:l,itemCount:c.length});let u={pipelineRunId:n,pipelineStepIndex:p};try{let d=await this.executeStep(r,c,p,l,u),m=Date.now()-o;if(i.push({type:r.type,index:p,durationMs:m,results:d.output}),this.events.onStepComplete?.({type:r.type,index:p,name:l,durationMs:m,successCount:d.successCount,errorCount:d.errorCount,filteredCount:d.filteredCount}),r.type==="reduce")return {pipelineRunId:n,steps:i,output:d.output,totalDurationMs:Date.now()-s};c=d.nextItems;}catch(d){throw this.events.onStepError?.({type:r.type,index:p,name:l,error:d instanceof Error?d:new Error(String(d))}),d}}let a=i[i.length-1];return {pipelineRunId:n,steps:i,output:a?.results??[],totalDurationMs:Date.now()-s}}async executeStep(e,n,i,c,s){if(e.type==="map"){let r=e.config,l=await this.swarm.map({items:n,...r,_pipelineContext:s,retry:this.wrapRetry(r.retry,i,c),verify:this.wrapVerify(r.verify,i,c),bestOf:this.wrapBestOf(r.bestOf,i,c)});return {output:[...l],nextItems:l.success,successCount:l.success.length,errorCount:l.error.length,filteredCount:0}}if(e.type==="filter"){let r=e.config,l=await this.swarm.filter({items:n,...r,_pipelineContext:s,retry:this.wrapRetry(r.retry,i,c),verify:this.wrapVerify(r.verify,i,c)}),o=r.emit??"success",u=o==="success"?l.success:o==="filtered"?l.filtered:[...l.success,...l.filtered];return {output:[...l],nextItems:u,successCount:l.success.length,errorCount:l.error.length,filteredCount:l.filtered.length}}let a=e.config,p=await this.swarm.reduce({items:n,...a,_pipelineContext:s,retry:this.wrapRetry(a.retry,i,c),verify:this.wrapVerify(a.verify,i,c)});return {output:p,nextItems:[],successCount:p.status==="success"?1:0,errorCount:p.status==="error"?1:0,filteredCount:0}}wrapRetry(e,n,i){if(e)return {...e,onItemRetry:(c,s,a)=>{e.onItemRetry?.(c,s,a),this.events.onItemRetry?.({stepIndex:n,stepName:i,itemIndex:c,attempt:s,error:a});}}}wrapVerify(e,n,i){if(e)return {...e,onWorkerComplete:(c,s,a)=>{e.onWorkerComplete?.(c,s,a),this.events.onWorkerComplete?.({stepIndex:n,stepName:i,itemIndex:c,attempt:s,status:a});},onVerifierComplete:(c,s,a,p)=>{e.onVerifierComplete?.(c,s,a,p),this.events.onVerifierComplete?.({stepIndex:n,stepName:i,itemIndex:c,attempt:s,passed:a,feedback:p});}}}wrapBestOf(e,n,i){if(e)return {...e,onCandidateComplete:(c,s,a)=>{e.onCandidateComplete?.(c,s,a),this.events.onCandidateComplete?.({stepIndex:n,stepName:i,itemIndex:c,candidateIndex:s,status:a});},onJudgeComplete:(c,s,a)=>{e.onJudgeComplete?.(c,s,a),this.events.onJudgeComplete?.({stepIndex:n,stepName:i,itemIndex:c,winnerIndex:s,reasoning:a});}}}},_e=class t extends Se{constructor(e,n,i){super(e,n,i);}on(e,n){if(typeof e=="string"){let i=`on${e.charAt(0).toUpperCase()}${e.slice(1)}`;return new t(this.swarm,this.steps,{...this.events,[i]:n})}return new t(this.swarm,this.steps,{...this.events,...e})}map(){throw new Error("Cannot add steps after reduce")}filter(){throw new Error("Cannot add steps after reduce")}reduce(){throw new Error("Cannot add steps after reduce")}};export{Ee as AGENT_REGISTRY,Cn as AGENT_TYPES,Q as Agent,X as Evolve,Ve as JUDGE_PROMPT,Se as Pipeline,ze as RETRY_FEEDBACK_PROMPT,Ut as SCHEMA_PROMPT,$ as SWARM_RESULT_BRAND,Dt as SYSTEM_PROMPT,W as Semaphore,st as Swarm,z as SwarmResultList,_e as TerminalPipeline,Te as VALIDATION_PRESETS,We as VERIFY_PROMPT,At as WORKSPACE_PROMPT,$t as WORKSPACE_SWE_PROMPT,I as applyTemplate,Je as buildWorkerSystemPrompt,M as createAgentParser,ce as createClaudeParser,le as createCodexParser,pe as createGeminiParser,_ as executeWithRetry,Re as expandPath,O as getAgentConfig,L as getMcpSettingsDir,F as getMcpSettingsPath,Sn as isValidAgentType,R as isZodSchema,K as jsonSchemaToString,Vn as parseNdjsonLine,Wn as parseNdjsonOutput,ut as parseQwenOutput,kt as readLocalDir,Ce as resolveStorageConfig,bt as saveLocalDir,Uo as storage,ie as writeClaudeMcpConfig,ae as writeCodexMcpConfig,se as writeGeminiMcpConfig,Ae as writeMcpConfig,re as writeQwenMcpConfig,B as zodSchemaToJson};